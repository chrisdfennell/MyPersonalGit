@page "/repo/{RepoName}"
@page "/repo/{RepoName}/{*Path}"
@page "/repo/{RepoName}/commit/{CommitHash}"
@using LibGit2Sharp
@using System.IO
@using System.Text
@using System.Linq
@using System.Text.RegularExpressions
@using Markdig
@using Markdig.Syntax
@using Markdig.Syntax.Inlines
@using Microsoft.AspNetCore.Components.Forms
@using MyPersonalGit.Data
@using BranchProtectionRule = MyPersonalGit.Models.BranchProtectionRule
@inject IConfiguration Config
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IBranchProtectionService BranchProtectionService
@inject IAdminService AdminService
@inject IRepositoryService RepoService
@inject ICollaboratorService CollaboratorService
@inject IReleaseService ReleaseService
@using MyPersonalGit.Services
@inject CurrentUserService UserService
@rendermode InteractiveServer

<PageTitle>@GetPageTitle() · Personal Git</PageTitle>

@if (notFound)
{
    <div class="container py-5 text-center">
        <h1 class="display-4 text-muted">Repository not found</h1>
        <p>The repository <strong>@RepoName</strong> does not exist on this server.</p>
        <div class="alert alert-warning d-inline-block mt-3">
            <small>Searching in: <code>@RootPath</code></small>
        </div>
        <br />
        <a href="/" class="btn btn-primary mt-3">Back to Dashboard</a>
    </div>
}
else
{
    <div class="repo-header border-bottom bg-light-subtle mb-4 pt-3">
        <div class="container-xl px-3">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="d-flex align-items-center">
                    <i class="bi bi-journal-bookmark text-muted me-2 h4 mb-0"></i>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0 h4">
                            <li class="breadcrumb-item"><a href="/profile/@UserService.Username" class="text-decoration-none">@UserService.Username</a></li>
                            <li class="breadcrumb-item active fw-bold text-body" aria-current="page">@RepoName</li>
                        </ol>
                    </nav>
                    <span class="badge rounded-pill border @(repoIsPrivate ? "bg-warning bg-opacity-10 text-warning border-warning-subtle" : "text-muted") fw-normal ms-2" style="font-size: 12px;">
                        @(repoIsPrivate ? "Private" : "Public")
                    </span>
                </div>

                <div class="d-flex gap-2">
                    @if (UserService.IsLoggedIn)
                    {
                        <button class="btn btn-light btn-sm border px-3 @(repoIsForked ? "disabled" : "")" @onclick="ForkRepository" disabled="@repoIsForked">
                            <i class="bi bi-diagram-3 me-1"></i> @(repoIsForked ? "Forked" : "Fork")
                            @if (repoForkCount > 0) { <span class="badge bg-secondary bg-opacity-10 text-body ms-1">@repoForkCount</span> }
                        </button>
                    }
                    <div class="dropdown">
                        <button class="btn btn-gh-primary btn-sm shadow-sm px-3" type="button" @onclick="() => showCloneDropdown = !showCloneDropdown">
                            <i class="bi bi-download me-1"></i> Code <i class="bi bi-caret-down-fill ms-1" style="font-size: 10px;"></i>
                        </button>
                    @if (showCloneDropdown)
                    {
                        <div class="dropdown-menu dropdown-menu-end show shadow p-3" style="width: 320px; display: block; position: absolute; right: 0; z-index: 1000;">
                            <h6 class="fw-bold small mb-2">Clone</h6>
                            <div class="input-group input-group-sm mb-2">
                                <input type="text" class="form-control bg-light" readonly value="@CloneUrl" id="cloneUrlInput" />
                                <button class="btn btn-outline-secondary" type="button" @onclick="CopyCloneUrl" title="Copy to clipboard"><i class="bi bi-clipboard"></i></button>
                            </div>
                            <p class="x-small text-muted mb-0">Use the Git HTTP URL to clone this repository.</p>

                            <hr class="my-2" />
                            <h6 class="fw-bold small mb-2">Download</h6>
                            <a href="/api/v1/repos/@(System.IO.Path.GetFileName(RepoFullPath))/archive/zip?ref=@currentBranch" class="btn btn-sm btn-outline-secondary w-100 text-start">
                                <i class="bi bi-file-earmark-zip me-2"></i>Download ZIP
                            </a>

                            @if (UserService.IsLoggedIn)
                            {
                                <hr class="my-2" />

                                <h6 class="fw-bold small mb-2">Add files</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-outline-secondary text-start" @onclick="NavigateToCreateFile">
                                        <i class="bi bi-file-earmark-plus me-2"></i>Create new file
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary text-start" @onclick="OpenUploadModal">
                                        <i class="bi bi-upload me-2"></i>Upload files
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary text-start" @onclick="OpenFolderUpload">
                                        <i class="bi bi-folder-plus me-2"></i>Upload folder
                                    </button>
                                </div>
                            }
                        </div>
                    }
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(repoForkedFrom))
            {
                <p class="text-muted small mb-2"><i class="bi bi-diagram-3 me-1"></i>forked from <a href="/repo/@repoForkedFrom" class="text-decoration-none">@repoForkedFrom</a></p>
            }
            @if (!string.IsNullOrEmpty(repoDescription))
            {
                <p class="text-muted small mb-3">@repoDescription</p>
            }

            <ul class="nav nav-tabs border-bottom-0 gap-2">
                <li class="nav-item">
                    <button class="nav-link @(activeTab == "code" || activeTab == "edit" || activeTab == "add-file" ? "active fw-bold" : "text-muted")" @onclick='() => SetTab("code")'>
                        <i class="bi bi-code-slash me-1"></i> Code
                    </button>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-muted text-decoration-none" href="/repo/@RepoName/issues">
                        <i class="bi bi-circle-fill me-1" style="font-size: 8px;"></i> Issues
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-muted text-decoration-none" href="/repo/@RepoName/pulls">
                        <i class="bi bi-git me-1"></i> Pull requests
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-muted text-decoration-none" href="/repo/@RepoName/actions">
                        <i class="bi bi-play-circle me-1"></i> Actions
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-muted text-decoration-none" href="/repo/@RepoName/wiki">
                        <i class="bi bi-book me-1"></i> Wiki
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-muted text-decoration-none" href="/repo/@RepoName/projects">
                        <i class="bi bi-kanban me-1"></i> Projects
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-muted text-decoration-none" href="/repo/@RepoName/security">
                        <i class="bi bi-shield-check me-1"></i> Security
                    </a>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(activeTab == "commits" || activeTab == "commit-detail" ? "active fw-bold" : "text-muted")" @onclick='() => SetTab("commits")'>
                        <i class="bi bi-clock-history me-1"></i> Commits
                        <span class="badge rounded-pill bg-secondary bg-opacity-10 text-body ms-1">@commitCount</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(activeTab == "graph" ? "active fw-bold" : "text-muted")" @onclick='() => SetTab("graph")'>
                        <i class="bi bi-diagram-3 me-1"></i> Graph
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(activeTab == "branches" ? "active fw-bold" : "text-muted")" @onclick='() => SetTab("branches")'>
                        <i class="bi bi-branches me-1"></i> Branches
                        <span class="badge rounded-pill bg-secondary bg-opacity-10 text-body ms-1">@branches.Count</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(activeTab == "tags" ? "active fw-bold" : "text-muted")" @onclick='() => SetTab("tags")'>
                        <i class="bi bi-tags me-1"></i> Tags
                        <span class="badge rounded-pill bg-secondary bg-opacity-10 text-body ms-1">@tags.Count</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(activeTab == "releases" ? "active fw-bold" : "text-muted")" @onclick='() => SetTab("releases")'>
                        <i class="bi bi-tag me-1"></i> Releases
                        @if (releases.Any()) { <span class="badge rounded-pill bg-secondary bg-opacity-10 text-body ms-1">@releases.Count</span> }
                    </button>
                </li>
                <li class="nav-item">
                    <a class="nav-link text-muted text-decoration-none" href="/repo/@RepoName/insights">
                        <i class="bi bi-graph-up me-1"></i> Insights
                    </a>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(activeTab == "settings" ? "active fw-bold" : "text-muted")" @onclick='() => SetTab("settings")'>
                        <i class="bi bi-gear me-1"></i> Settings
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <div class="container-xl px-3">
        @if (activeTab == "code")
        {
            @if (isEmpty)
            {
                <div class="blankslate p-5 border rounded-3 bg-light text-center shadow-sm">
                    <i class="bi bi-terminal-fill display-4 text-muted mb-3"></i>
                    <h3 class="h5 fw-bold">Quick setup — if you’ve done this kind of thing before</h3>
                    <p class="text-muted mb-4 small">
                        Get started by <button class="btn btn-link p-0 pb-1 small fw-bold text-decoration-none" @onclick="EnterAddFileMode">creating a new file</button> or pushing an existing repository.
                    </p>
                    <div class="bg-dark text-white p-3 rounded-2 text-start font-monospace small mx-auto mt-3" style="max-width: 600px;">
                        <span class="text-success"># Push an existing repository</span><br />
                        git remote add origin http://localhost:7200/@RepoName<br />
                        git branch -M main<br />
                        git push -u origin main
                    </div>
                </div>
            }
            else if (isFile)
            {
                var breadcrumbs = GetBreadcrumbs();
                <div class="file-view mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0 small">
                                <li class="breadcrumb-item"><a href="/repo/@RepoName">@RepoName</a></li>
                                @foreach (var crumb in breadcrumbs)
                                {
                                    if (crumb.IsLast)
                                    {
                                        <li class="breadcrumb-item active">@crumb.Name</li>
                                    }
                                    else
                                    {
                                        <li class="breadcrumb-item"><a href="/repo/@RepoName/@crumb.Path">@crumb.Name</a></li>
                                    }
                                }
                            </ol>
                        </nav>
                        <div class="btn-group shadow-sm">
                            @if (UserService.IsLoggedIn)
                            {
                                <button class="btn btn-light btn-sm border" @onclick="EnterEditMode"><i class="bi bi-pencil me-1"></i> Edit</button>
                            }
                            <button class="btn btn-light btn-sm border" @onclick="ViewFileHistory"><i class="bi bi-clock-history me-1"></i> History</button>
                            <button class="btn @(activeTab == "blame" ? "btn-secondary" : "btn-light") btn-sm border" @onclick="ToggleBlameView"><i class="bi bi-person-lines-fill me-1"></i> Blame</button>
                            @if (UserService.IsLoggedIn)
                            {
                                <button class="btn btn-light btn-sm border" @onclick="() => showDeleteModal = true"><i class="bi bi-trash me-1 text-danger"></i> Delete</button>
                            }
                            <button class="btn @(showRaw ? "btn-secondary" : "btn-light") btn-sm border" @onclick="() => showRaw = !showRaw">
                                <i class="bi bi-code-square me-1"></i> Raw
                            </button>
                        </div>
                    </div>
                    <div class="card shadow-sm overflow-hidden">
                        <div class="card-header bg-light-subtle d-flex justify-content-between align-items-center py-2 px-3">
                            <span class="small text-muted">@lineCount lines · @fileSize bytes</span>
                            <div class="d-flex gap-2">
                                @if (Path?.EndsWith(".md", StringComparison.OrdinalIgnoreCase) == true)
                                {
                                    <span class="badge bg-info bg-opacity-10 text-info border border-info-subtle" style="font-size: 10px;">Markdown</span>
                                }
                                <i class="bi bi-lock small text-muted"></i>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            @if (Path?.EndsWith(".md", StringComparison.OrdinalIgnoreCase) == true && !showRaw)
                            {
                                <div class="p-4 markdown-body">
                                    @ConvertMarkdownToHtml(fileContent)
                                </div>
                            }
                            else
                            {
                                <pre class="m-0 line-numbers" style="font-size: 13px; line-height: 1.5; overflow-x: auto; padding: 0.5em 0.5em 0.5em 3.8em;"><code class="@GetPrismLanguageClass(Path)">@fileContent</code></pre>
                            }
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="row">
                <div class="@(languageStats.Any() ? "col-md-9" : "col-12")">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="d-flex align-items-center gap-2">
                        <div class="dropdown">
                            <button class="btn btn-light btn-sm border fw-semibold shadow-sm dropdown-toggle" type="button" @onclick="() => showBranchDropdown = !showBranchDropdown">
                                <i class="bi bi-branches me-1"></i> @currentBranch
                            </button>
                            @if (showBranchDropdown)
                            {
                                <div class="dropdown-menu show shadow-sm" style="position: absolute; z-index: 1000; display: block;">
                                    <div class="px-3 py-2 border-bottom small fw-bold">Switch branches</div>
                                    @foreach (var b in branches)
                                    {
                                        <button class="dropdown-item small d-flex align-items-center" @onclick="() => SwitchBranch(b.Name)">
                                            @if (b.Name == currentBranch)
                                            {
                                                <i class="bi bi-check2 me-2 text-primary"></i>
                                            }
                                            else
                                            {
                                                <span class="me-4"></span>
                                            }
                                            @b.Name
                                        </button>
                                    }
                                </div>
                            }
                        </div>

                        <div class="input-group input-group-sm" style="width: 240px;">
                            <span class="input-group-text border-end-0 text-muted"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control border-start-0 ps-0 shadow-none" placeholder="Go to file..." @bind="fileSearchTerm" @bind:event="oninput" />
                        </div>
                    </div>
                    @if (UserService.IsLoggedIn)
                    {
                        <div class="d-flex gap-2">
                            <div class="dropdown">
                                <button class="btn btn-light btn-sm border shadow-sm px-3 dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    Add file
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" @onclick="EnterAddFileMode" @onclick:preventDefault>Create new file</a></li>
                                    <li><a class="dropdown-item" href="#" @onclick="() => showUploadModal = true" @onclick:preventDefault>Upload files</a></li>
                                    <li><a class="dropdown-item" href="#" @onclick="OpenFolderUpload" @onclick:preventDefault>Upload folder</a></li>
                                </ul>
                            </div>
                        </div>
                    }
                </div>

                <div class="card border shadow-sm mb-4">
                    <div class="card-header bg-light-subtle py-2">
                        <div class="d-flex justify-content-between align-items-center small">
                            @if (latestCommit != null)
                            {
                                <div>
                                    <strong class="text-body">@latestCommit.AuthorName</strong>
                                    <span class="text-muted ms-2">@latestCommit.Message</span>
                                </div>
                                <div class="text-muted">
                                    <a href="/repo/@RepoName/commit/@latestCommit.Sha" class="text-decoration-none font-monospace small">@latestCommit.ShortSha</a> · @GetRelativeTime(latestCommit.Date)
                                </div>
                            }
                        </div>
                    </div>
                    <div class="list-group list-group-flush">
                        @if (!string.IsNullOrEmpty(Path) && string.IsNullOrEmpty(fileSearchTerm))
                        {
                            <div class="list-group-item list-group-item-action py-2 px-3 border-0 border-bottom">
                                <a href="/repo/@RepoName/@GetParentPath()" class="text-decoration-none text-primary fw-bold">..</a>
                            </div>
                        }

                        @{
                            var displayItems = treeItems.Where(i => string.IsNullOrEmpty(fileSearchTerm) || i.Name.Contains(fileSearchTerm, StringComparison.OrdinalIgnoreCase)).ToList();
                        }

                        @if (!displayItems.Any())
                        {
                            <div class="list-group-item py-4 text-center text-muted small">No files matching "@fileSearchTerm"</div>
                        }

                        @foreach (var item in displayItems)
                        {
                            var itemPath = string.IsNullOrEmpty(Path) ? item.Name : $"{Path}/{item.Name}";
                            <div class="list-group-item list-group-item-action d-flex align-items-center py-2 px-3 border-0 border-bottom">
                                <div style="width: 30px;">
                                    @if (item.IsDirectory)
                                    {
                                        <i class="bi bi-folder-fill text-primary-emphasis"></i>
                                    }
                                    else
                                    {
                                        <i class="bi bi-file-earmark-text text-muted"></i>
                                    }
                                </div>
                                <div class="flex-grow-1">
                                    <a href="/repo/@RepoName/@itemPath" class="text-decoration-none text-body d-block">@item.Name</a>
                                </div>
                                <div class="text-muted small d-none d-md-block text-truncate" style="width: 250px;" title="@item.LastCommitMessage">
                                    @(string.IsNullOrEmpty(item.LastCommitMessage) ? latestCommit?.Message : item.LastCommitMessage)
                                </div>
                                <div class="text-muted small text-end" style="width: 100px;">
                                    @GetRelativeTime(item.LastCommitDate ?? latestCommit?.Date)
                                </div>
                            </div>
                        }
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(readmeContent) && string.IsNullOrEmpty(fileSearchTerm))
                {
                    <div class="readme-container mb-5">
                        <div class="card border shadow-sm">
                            <div class="card-header py-2 d-flex align-items-center">
                                <i class="bi bi-book text-muted me-2"></i>
                                <span class="fw-bold small">README.md</span>
                            </div>
                            <div class="card-body p-4">
                                <div class="readme-body" style="font-size: 15px; line-height: 1.6;">
                                    @ConvertMarkdownToHtml(readmeContent)
                                </div>
                            </div>
                        </div>
                    </div>
                }

                </div>

                @if (languageStats.Any() && string.IsNullOrEmpty(fileSearchTerm))
                {
                    <div class="col-md-3">
                        <div class="border-bottom pb-3 mb-3">
                            <h6 class="fw-bold mb-3">About</h6>
                            @if (!string.IsNullOrEmpty(repoDescription))
                            {
                                <p class="text-muted small">@repoDescription</p>
                            }
                        </div>
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">Languages</h6>
                            <div class="language-bar d-flex rounded overflow-hidden" style="height: 8px;">
                                @foreach (var lang in languageStats)
                                {
                                    <div style="width: @lang.Percentage.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)%; background-color: @lang.Color;" title="@lang.Name @lang.Percentage.ToString("F1")%"></div>
                                }
                            </div>
                            <div class="d-flex flex-wrap gap-2 mt-2">
                                @foreach (var lang in languageStats)
                                {
                                    <div class="d-flex align-items-center small">
                                        <span class="rounded-circle d-inline-block me-1" style="width: 10px; height: 10px; background-color: @lang.Color;"></span>
                                        <span class="fw-bold me-1">@lang.Name</span>
                                        <span class="text-muted">@lang.Percentage.ToString("F1")%</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
                </div>
            }
        }
        else if (activeTab == "branches")
        {
            <div class="branches-view mb-5">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">Branches</h5>
                    <button class="btn btn-gh-primary btn-sm" @onclick="() => showNewBranchModal = true">New branch</button>
                </div>

                <div class="card border shadow-sm">
                    <div class="card-header bg-light-subtle py-2 small fw-bold">Active branches</div>
                    <div class="list-group list-group-flush">
                        @if (!branches.Any())
                        {
                            <div class="list-group-item py-4 text-center text-muted small">No branches found.</div>
                        }
                        @foreach (var b in branches)
                        {
                            <div class="list-group-item d-flex justify-content-between align-items-center py-3">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-branches text-muted me-3"></i>
                                    <div>
                                        <button class="btn btn-link p-0 text-decoration-none text-body fw-bold" @onclick="() => SwitchBranch(b.Name)">@b.Name</button>
                                        @if (b.Name == currentBranch)
                                        {
                                            <span class="badge rounded-pill bg-primary bg-opacity-10 text-primary border border-primary-subtle ms-2 small" style="font-size: 10px;">Default</span>
                                        }
                                        @if (branchProtectionRules.Any(r => BranchMatchesPattern(b.Name, r.BranchPattern)))
                                        {
                                            <span class="badge rounded-pill bg-warning bg-opacity-10 text-warning border border-warning-subtle ms-2 small" style="font-size: 10px;"><i class="bi bi-shield-lock me-1"></i>Protected</span>
                                        }
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-light btn-sm border" @onclick="() => DeleteBranch(b.Name)"
                                            disabled="@(b.Name == currentBranch || branchProtectionRules.Any(r => BranchMatchesPattern(b.Name, r.BranchPattern) && r.PreventDeletion))">
                                        <i class="bi bi-trash text-danger"></i>
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        else if (activeTab == "tags")
        {
            <div class="tags-view mb-5">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">Tags</h5>
                    <button class="btn btn-gh-primary btn-sm" @onclick="() => showNewTagModal = true">New tag</button>
                </div>

                <div class="card border shadow-sm">
                    <div class="card-header bg-light-subtle py-2 small fw-bold">Release tags</div>
                    <div class="list-group list-group-flush">
                        @if (!tags.Any())
                        {
                            <div class="list-group-item py-4 text-center text-muted small">No tags have been created yet.</div>
                        }
                        @foreach (var t in tags)
                        {
                            <div class="list-group-item d-flex justify-content-between align-items-center py-3">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-tag text-muted me-3"></i>
                                    <div>
                                        <span class="fw-bold">@t.Name</span>
                                        <div class="small text-muted font-monospace">@t.TargetSha.Substring(0, 7)</div>
                                    </div>
                                </div>
                                <div class="d-flex gap-2">
                                    <a href="/repo/@RepoName/commit/@t.TargetSha" class="btn btn-light btn-sm border px-3">View commit</a>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        else if (activeTab == "releases")
        {
            <div class="releases-view mb-5">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">Releases</h5>
                    @if (UserService.IsLoggedIn)
                    {
                        <button class="btn btn-gh-primary btn-sm" @onclick="() => showCreateRelease = true">
                            <i class="bi bi-plus-lg me-1"></i>New release
                        </button>
                    }
                </div>

                @if (showCreateRelease)
                {
                    <div class="card border shadow-sm mb-4">
                        <div class="card-header bg-light-subtle py-2">
                            <h6 class="fw-bold mb-0 small">Create a new release</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Tag</label>
                                <select class="form-select form-select-sm" @bind="newReleaseTagName">
                                    <option value="">Choose a tag...</option>
                                    @foreach (var t in tags)
                                    {
                                        <option value="@t.Name">@t.Name</option>
                                    }
                                </select>
                                <div class="form-text">Select an existing tag for this release.</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Release title</label>
                                <input type="text" class="form-control form-control-sm" @bind="newReleaseTitle" placeholder="e.g. v1.0.0" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Description</label>
                                <textarea class="form-control form-control-sm" @bind="newReleaseBody" rows="6" placeholder="Describe this release..."></textarea>
                            </div>
                            <div class="d-flex gap-3 mb-3">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="releaseDraft" @bind="newReleaseIsDraft" />
                                    <label class="form-check-label small" for="releaseDraft">Draft</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="releasePrerelease" @bind="newReleaseIsPrerelease" />
                                    <label class="form-check-label small" for="releasePrerelease">Pre-release</label>
                                </div>
                            </div>
                            @if (!string.IsNullOrEmpty(releaseError))
                            {
                                <div class="alert alert-danger small py-2">@releaseError</div>
                            }
                            <div class="d-flex gap-2">
                                <button class="btn btn-gh-primary btn-sm" @onclick="CreateRelease">Publish release</button>
                                <button class="btn btn-light btn-sm border" @onclick="() => showCreateRelease = false">Cancel</button>
                            </div>
                        </div>
                    </div>
                }

                @if (!releases.Any() && !showCreateRelease)
                {
                    <div class="card border shadow-sm">
                        <div class="card-body text-center py-5">
                            <i class="bi bi-tag display-4 text-muted mb-3 d-block"></i>
                            <h6 class="fw-bold">No releases yet</h6>
                            <p class="text-muted small">Create a release to bundle your software and share it with users.</p>
                        </div>
                    </div>
                }
                else
                {
                    @foreach (var release in releases)
                    {
                        <div class="card border shadow-sm mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="fw-bold mb-1">
                                            <i class="bi bi-tag me-1 text-success"></i> @release.Title
                                            @if (release.IsDraft) { <span class="badge bg-warning text-body ms-1">Draft</span> }
                                            @if (release.IsPrerelease) { <span class="badge bg-info text-body ms-1">Pre-release</span> }
                                        </h5>
                                        <div class="small text-muted mb-2">
                                            <span class="font-monospace bg-light px-1 rounded">@release.TagName</span>
                                            <span class="mx-1">&middot;</span>
                                            @release.Author released this @GetRelativeTime(release.CreatedAt)
                                        </div>
                                    </div>
                                    @if (UserService.IsLoggedIn)
                                    {
                                        <button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteRelease(release.Id)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    }
                                </div>

                                @if (!string.IsNullOrEmpty(release.Body))
                                {
                                    <div class="border-top pt-3 mt-2">
                                        @ConvertMarkdownToHtml(release.Body)
                                    </div>
                                }

                                @if (release.Assets.Any())
                                {
                                    <div class="border-top pt-3 mt-2">
                                        <h6 class="small fw-bold mb-2">Assets</h6>
                                        @foreach (var asset in release.Assets)
                                        {
                                            <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-file-earmark me-2 text-muted"></i>
                                                    <a href="/api/v1/repos/@(System.IO.Path.GetFileName(RepoFullPath))/releases/@release.Id/assets/@asset.Id" class="text-decoration-none small">@asset.FileName</a>
                                                    <span class="text-muted small ms-2">(@FormatFileSize(asset.Size))</span>
                                                </div>
                                                <div class="d-flex align-items-center gap-2">
                                                    <span class="text-muted x-small"><i class="bi bi-download me-1"></i>@asset.DownloadCount</span>
                                                    @if (UserService.IsLoggedIn)
                                                    {
                                                        <button class="btn btn-outline-danger btn-sm py-0 px-1" @onclick="() => DeleteAsset(asset.Id, release.Id)">
                                                            <i class="bi bi-x-lg" style="font-size: 10px;"></i>
                                                        </button>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }

                                @if (UserService.IsLoggedIn)
                                {
                                    <div class="border-top pt-3 mt-2">
                                        <div class="d-flex align-items-center gap-2">
                                            <InputFile OnChange="(e) => HandleAssetUpload(e, release.Id)" class="form-control form-control-sm" style="max-width: 300px;" />
                                            @if (assetUploading)
                                            {
                                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                            }
                                        </div>
                                        @if (!string.IsNullOrEmpty(assetUploadError))
                                        {
                                            <div class="text-danger small mt-1">@assetUploadError</div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                }
            </div>
        }
        else if (activeTab == "settings")
        {
            <div class="settings-view mb-5">
                <div class="mb-4">
                    <h5 class="fw-bold">Settings</h5>
                    <p class="text-muted small">Manage repository lifecycle.</p>
                </div>

                @if (UserService.IsLoggedIn)
                {
                    <div class="card border shadow-sm mb-4">
                        <div class="card-header bg-light-subtle py-2 small fw-bold">
                            <i class="bi bi-info-circle me-1"></i> General
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Description</label>
                                <input type="text" class="form-control form-control-sm" @bind="settingsDescription" placeholder="Short description of your repository" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Visibility</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="settingsVisibility" id="settingsPublic" checked="@(!settingsIsPrivate)" @onchange="() => settingsIsPrivate = false" />
                                    <label class="form-check-label small" for="settingsPublic">
                                        <i class="bi bi-journal-bookmark me-1"></i> Public — anyone can see this repository
                                    </label>
                                </div>
                                <div class="form-check mt-1">
                                    <input class="form-check-input" type="radio" name="settingsVisibility" id="settingsPrivate" checked="@settingsIsPrivate" @onchange="() => settingsIsPrivate = true" />
                                    <label class="form-check-label small" for="settingsPrivate">
                                        <i class="bi bi-lock me-1"></i> Private — only you can see this repository
                                    </label>
                                </div>
                            </div>
                            <button class="btn btn-gh-primary btn-sm" @onclick="SaveGeneralSettings">Save changes</button>
                            @if (!string.IsNullOrEmpty(settingsSaveMessage))
                            {
                                <span class="text-success small ms-2"><i class="bi bi-check-circle me-1"></i>@settingsSaveMessage</span>
                            }
                        </div>
                    </div>
                }

                <div class="card border shadow-sm mb-4">
                    <div class="card-header bg-light-subtle py-2 small fw-bold">
                        <i class="bi bi-shield-lock me-1"></i> Branch protection rules
                    </div>
                    <div class="card-body">
                        @if (branchProtectionRules.Any())
                        {
                            <div class="list-group list-group-flush mb-3">
                                @foreach (var rule in branchProtectionRules)
                                {
                                    <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                        <div>
                                            <span class="fw-bold font-monospace">@rule.BranchPattern</span>
                                            <div class="small text-muted mt-1">
                                                @if (rule.RequirePullRequest) { <span class="badge bg-info bg-opacity-10 text-info border border-info-subtle me-1">Require PR</span> }
                                                @if (rule.RequiredApprovals > 0) { <span class="badge bg-info bg-opacity-10 text-info border border-info-subtle me-1">@rule.RequiredApprovals approval(s)</span> }
                                                @if (rule.PreventForcePush) { <span class="badge bg-warning bg-opacity-10 text-warning border border-warning-subtle me-1">No force push</span> }
                                                @if (rule.PreventDeletion) { <span class="badge bg-warning bg-opacity-10 text-warning border border-warning-subtle me-1">No deletion</span> }
                                                @if (rule.RequireLinearHistory) { <span class="badge bg-secondary bg-opacity-10 text-secondary border me-1">Linear history</span> }
                                            </div>
                                        </div>
                                        @if (UserService.IsLoggedIn)
                                        {
                                            <button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteBranchProtectionRule(rule.Id)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        }
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted small mb-3">No branch protection rules configured yet.</p>
                        }

                        @if (showAddProtectionRule)
                        {
                            <div class="border rounded p-3 bg-light-subtle">
                                <h6 class="fw-bold small mb-3">Add branch protection rule</h6>
                                <div class="mb-3">
                                    <label class="form-label small fw-bold">Branch name pattern</label>
                                    <input type="text" class="form-control form-control-sm" @bind="newProtectionRule.BranchPattern" placeholder="main, release/*, etc." />
                                    <div class="form-text">Use * as wildcard. Example: release/* matches release/v1, release/v2, etc.</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input type="checkbox" class="form-check-input" id="requirePR" @bind="newProtectionRule.RequirePullRequest" />
                                            <label class="form-check-label small" for="requirePR">Require pull request before merging</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input type="checkbox" class="form-check-input" id="preventForce" @bind="newProtectionRule.PreventForcePush" />
                                            <label class="form-check-label small" for="preventForce">Prevent force pushes</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input type="checkbox" class="form-check-input" id="preventDelete" @bind="newProtectionRule.PreventDeletion" />
                                            <label class="form-check-label small" for="preventDelete">Prevent branch deletion</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-2">
                                            <input type="checkbox" class="form-check-input" id="linearHistory" @bind="newProtectionRule.RequireLinearHistory" />
                                            <label class="form-check-label small" for="linearHistory">Require linear history</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input type="checkbox" class="form-check-input" id="requireChecks" @bind="newProtectionRule.RequireStatusChecks" />
                                            <label class="form-check-label small" for="requireChecks">Require status checks</label>
                                        </div>
                                    </div>
                                </div>
                                @if (newProtectionRule.RequirePullRequest)
                                {
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold">Required approvals</label>
                                        <input type="number" class="form-control form-control-sm" style="width: 100px;" @bind="newProtectionRule.RequiredApprovals" min="0" max="10" />
                                    </div>
                                }
                                <div class="d-flex gap-2">
                                    @if (UserService.IsLoggedIn)
                                    {
                                        <button class="btn btn-gh-primary btn-sm" @onclick="SaveBranchProtectionRule" disabled="@string.IsNullOrWhiteSpace(newProtectionRule.BranchPattern)">Save rule</button>
                                    }
                                    <button class="btn btn-light btn-sm border" @onclick="() => showAddProtectionRule = false">Cancel</button>
                                </div>
                            </div>
                        }
                        else
                        {
                            @if (UserService.IsLoggedIn)
                            {
                                <button class="btn btn-outline-primary btn-sm" @onclick="() => showAddProtectionRule = true">
                                    <i class="bi bi-plus-lg me-1"></i>Add rule
                                </button>
                            }
                        }
                    </div>
                </div>

                @if (UserService.IsLoggedIn)
                {
                    <div class="card border shadow-sm mb-4">
                        <div class="card-header bg-light-subtle py-2 small fw-bold">
                            <i class="bi bi-people me-1"></i> Collaborators
                        </div>
                        <div class="card-body">
                            @if (collaborators.Any())
                            {
                                <div class="list-group list-group-flush mb-3">
                                    @foreach (var collab in collaborators)
                                    {
                                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                            <div>
                                                <a href="/profile/@collab.Username" class="text-decoration-none fw-bold">@collab.Username</a>
                                                <span class="badge bg-secondary bg-opacity-10 text-secondary ms-2">@collab.Permission</span>
                                            </div>
                                            <button class="btn btn-outline-danger btn-sm" @onclick="() => RemoveCollaborator(collab.Username)">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <p class="text-muted small mb-3">No collaborators yet.</p>
                            }
                            <div class="d-flex gap-2">
                                <input type="text" class="form-control form-control-sm" @bind="newCollaboratorUsername" placeholder="Username" style="max-width: 200px;" />
                                <select class="form-select form-select-sm" @bind="newCollaboratorPermission" style="max-width: 120px;">
                                    <option value="Read">Read</option>
                                    <option value="Write">Write</option>
                                    <option value="Admin">Admin</option>
                                </select>
                                <button class="btn btn-gh-primary btn-sm" @onclick="AddCollaborator" disabled="@string.IsNullOrWhiteSpace(newCollaboratorUsername)">
                                    <i class="bi bi-plus-lg me-1"></i>Add
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card border-danger shadow-sm">
                        <div class="card-header bg-danger bg-opacity-10 text-danger py-2 small fw-bold border-danger border-opacity-25">Danger Zone</div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="fw-bold mb-0">Delete this repository</h6>
                                    <p class="text-muted small mb-0">Once you delete a repository, there is no going back.</p>
                                </div>
                                <button class="btn btn-outline-danger btn-sm px-3" @onclick="() => showDeleteRepoModal = true">Delete this repository</button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else if (activeTab == "blame")
        {
            <div class="mb-3">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0 small">
                        <li class="breadcrumb-item"><a href="/repo/@RepoName" class="text-decoration-none">@RepoName</a></li>
                        <li class="breadcrumb-item active">@Path</li>
                    </ol>
                </nav>
            </div>
            <div class="card shadow-sm overflow-hidden">
                <div class="card-header bg-light-subtle py-2 px-3">
                    <span class="small fw-bold"><i class="bi bi-person-lines-fill me-1"></i> Blame</span>
                    <button class="btn btn-link btn-sm text-decoration-none float-end" @onclick="ExitBlameView">
                        <i class="bi bi-arrow-left me-1"></i>Back to code
                    </button>
                </div>
                <div class="card-body p-0">
                    @if (blameLines.Any())
                    {
                        <table class="table table-sm table-borderless mb-0 font-monospace" style="font-size: 12px;">
                            @foreach (var line in blameLines)
                            {
                                <tr class="@(line.HunkIndex % 2 == 0 ? "" : "bg-light")">
                                    @if (line.IsFirstInHunk)
                                    {
                                        <td class="text-muted border-end px-2 py-0 text-nowrap align-top" style="width: 200px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;" rowspan="@line.HunkLineCount">
                                            <div class="d-flex flex-column">
                                                <a href="/repo/@RepoName/commit/@line.CommitSha" class="text-decoration-none text-primary" style="font-size: 11px;">@line.ShortSha</a>
                                                <span class="text-truncate" style="font-size: 11px;">@line.Author</span>
                                                <span style="font-size: 10px;" class="text-muted">@line.Date.ToString("yyyy-MM-dd")</span>
                                            </div>
                                        </td>
                                    }
                                    <td class="text-muted text-end border-end px-2 py-0 select-none" style="width: 40px;">@line.LineNumber</td>
                                    <td class="px-2 py-0"><pre class="m-0 d-inline" style="white-space: pre-wrap;">@line.Content</pre></td>
                                </tr>
                            }
                        </table>
                    }
                    else
                    {
                        <p class="text-muted p-3">Unable to load blame information.</p>
                    }
                </div>
            </div>
        }
        else if (activeTab == "edit" || activeTab == "add-file")
        {
            @if (UserService.IsLoggedIn)
            {
                <div class="editor-view mb-5">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0">
                            @(activeTab == "edit" ? "Editing " : "Adding file to ")
                            <span class="text-muted">@(activeTab == "edit" ? Path : (string.IsNullOrEmpty(Path) ? "/" : Path))</span>
                        </h5>
                        <button class="btn btn-link text-danger text-decoration-none btn-sm" @onclick='() => SetTab("code")'>Cancel</button>
                    </div>

                    @if (activeTab == "add-file")
                    {
                        <div class="mb-3">
                            <input type="text" class="form-control form-control-sm font-monospace" @bind="newFileName" @bind:event="oninput" placeholder="Name your file (e.g. README.md)..." />
                        </div>
                    }

                    <div class="card border shadow-sm mb-4">
                        @{
                            var editingFilePath = activeTab == "edit" ? Path : newFileName;
                            var isEditingMarkdown = editingFilePath?.EndsWith(".md", StringComparison.OrdinalIgnoreCase) == true;
                        }
                        <div class="card-header bg-light-subtle py-1 d-flex align-items-center gap-2">
                            <button class="btn btn-sm @(editorMode == "edit" ? "btn-secondary" : "btn-light border") px-3" @onclick='() => editorMode = "edit"'>
                                <i class="bi bi-code-slash me-1"></i>Edit file
                            </button>
                            @if (isEditingMarkdown)
                            {
                                <button class="btn btn-sm @(editorMode == "preview" ? "btn-secondary" : "btn-light border") px-3" @onclick='() => editorMode = "preview"'>
                                    <i class="bi bi-eye me-1"></i>Preview
                                </button>
                            }
                            <span class="ms-auto small text-muted">
                                @if (!string.IsNullOrEmpty(editingContent))
                                {
                                    @($"{editingContent.Split('\n').Length} lines · {Encoding.UTF8.GetByteCount(editingContent)} bytes")
                                }
                            </span>
                        </div>
                        <div class="card-body p-0">
                            @if (editorMode == "preview" && isEditingMarkdown)
                            {
                                <div class="p-4 markdown-body" style="min-height: 400px;">
                                    @ConvertMarkdownToHtml(editingContent)
                                </div>
                            }
                            else
                            {
                                <div class="editor-wrapper position-relative">
                                    <div class="line-numbers-gutter position-absolute text-end pe-2 text-muted user-select-none"
                                         style="left: 0; top: 0; width: 50px; height: 100%; font-size: 13px; line-height: 1.5; padding-top: 12px; background: #f6f8fa; border-right: 1px solid #d0d7de; font-family: ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace; overflow: hidden;">
                                        @{
                                            var editorLineCount = string.IsNullOrEmpty(editingContent) ? 1 : editingContent.Split('\n').Length;
                                        }
                                        @for (int ln = 1; ln <= editorLineCount; ln++)
                                        {
                                            <div style="height: 19.5px; font-size: 12px; color: #8b949e;">@ln</div>
                                        }
                                    </div>
                                    <textarea id="codeEditor" class="form-control border-0 font-monospace"
                                              style="min-height: 400px; font-size: 13px; line-height: 1.5; resize: vertical; padding-left: 60px; padding-top: 12px; padding-right: 12px;"
                                              @bind="editingContent" @bind:event="oninput"></textarea>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="card border shadow-sm">
                        <div class="card-header bg-light-subtle py-2">
                            <span class="fw-bold small">Commit changes</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <input type="text" class="form-control form-control-sm fw-semibold" @bind="commitMessage" @bind:event="oninput" placeholder="Commit message" />
                                    </div>
                                    <div class="mb-3">
                                        <textarea class="form-control form-control-sm" rows="3" @bind="commitDescription" @bind:event="oninput" placeholder="Add description..."></textarea>
                                    </div>
                                    <button class="btn btn-gh-primary btn-sm px-4" @onclick="CommitChanges" disabled="@(activeTab == "add-file" && string.IsNullOrWhiteSpace(newFileName))">Commit changes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-warning">You must be logged in to edit files.</div>
            }
        }
        else if (activeTab == "commits")
        {
            <div class="timeline border-start ms-3 ps-4 mt-3">
                @if (!string.IsNullOrEmpty(Path))
                {
                    <div class="mb-3">
                        <span class="badge bg-light text-body border fw-normal">History for: <code>@Path</code></span>
                        <button class="btn btn-link btn-sm text-decoration-none" @onclick="ClearFileFilter">Clear filter</button>
                    </div>
                }
                @foreach (var commit in commitHistory)
                {
                    <div class="commit-item mb-4 position-relative">
                        <div class="commit-dot position-absolute border border-2 border-secondary" style="width: 12px; height: 12px; left: -31px; top: 6px; border-radius: 50%; background-color: var(--bs-body-bg);"></div>
                        <div class="card border shadow-sm">
                            <div class="card-body py-2 px-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <h6 class="mb-1 fw-bold">@commit.Message</h6>
                                    <a href="/repo/@RepoName/commit/@commit.Sha" class="badge bg-light text-primary border border-primary-subtle font-monospace text-decoration-none">@commit.ShortSha</a>
                                </div>
                                <div class="text-muted small">
                                    <strong>@commit.AuthorName</strong> committed @GetRelativeTime(commit.Date)
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else if (activeTab == "graph")
        {
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light-subtle py-2">
                    <h6 class="fw-bold mb-0 small"><i class="bi bi-diagram-3 me-1"></i> Commit Graph</h6>
                </div>
                <div class="card-body p-0" style="overflow-x: auto;">
                    @if (graphEntries.Any())
                    {
                        <div class="d-flex">
                            <svg width="@(graphMaxLane * 30 + 40)" height="@(graphEntries.Count * 32 + 20)" style="flex-shrink: 0;">
                                @foreach (var entry in graphEntries)
                                {
                                    var cx = entry.Lane * 30 + 20;
                                    var cy = entry.Row * 32 + 26;
                                    @foreach (var parentRow in entry.ParentRows)
                                    {
                                        var parentEntry = graphEntries.FirstOrDefault(e => e.Row == parentRow);
                                        if (parentEntry != null)
                                        {
                                            var px = parentEntry.Lane * 30 + 20;
                                            var py = parentEntry.Row * 32 + 26;
                                            <line x1="@cx" y1="@cy" x2="@px" y2="@py" stroke="@entry.Color" stroke-width="2" opacity="0.6" />
                                        }
                                    }
                                }
                                @foreach (var entry in graphEntries)
                                {
                                    var cx = entry.Lane * 30 + 20;
                                    var cy = entry.Row * 32 + 26;
                                    <circle cx="@cx" cy="@cy" r="5" fill="@entry.Color" stroke="white" stroke-width="2" />
                                }
                            </svg>
                            <div class="flex-grow-1" style="font-size: 12px; font-family: monospace;">
                                @foreach (var entry in graphEntries)
                                {
                                    <div style="height: 32px; line-height: 32px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 8px;">
                                        <a href="/repo/@RepoName/commit/@entry.Sha" class="text-decoration-none" style="color: #0969da;">@entry.ShortSha</a>
                                        <span class="ms-2">@TruncateMessage(entry.Message, 60)</span>
                                        <span class="ms-2 text-muted">@entry.Author · @GetRelativeTime(entry.Date)</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted p-3">No commits to display.</p>
                    }
                </div>
            </div>
        }
        else if (activeTab == "commit-detail" && selectedCommit != null)
        {
            <div class="commit-detail mb-5">
                <div class="card border shadow-sm mb-4">
                    <div class="card-body bg-light-subtle">
                        <h4 class="fw-bold mb-1">@selectedCommit.Message</h4>
                        <div class="text-muted small">
                            <strong>@selectedCommit.AuthorName</strong> authored @selectedCommit.Date.ToString("f")
                        </div>
                        <hr />
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex gap-3 small text-muted">
                                <span>commit <code>@selectedCommit.Sha</code></span>
                            </div>
                            <div class="btn-group btn-group-sm border rounded shadow-sm">
                                <button type="button" class="btn btn-light @(diffViewMode == "unified" ? "active border-primary" : "")" @onclick='() => diffViewMode = "unified"'>Unified</button>
                                <button type="button" class="btn btn-light @(diffViewMode == "split" ? "active border-primary" : "")" @onclick='() => diffViewMode = "split"'>Split</button>
                            </div>
                        </div>
                    </div>
                </div>

                <h6 class="fw-bold text-muted small text-uppercase mb-3">Showing @commitPatches.Count changed files</h6>
                @foreach (var patch in commitPatches)
                {
                    <div class="card border shadow-sm mb-3">
                        <div class="card-header py-2 bg-light-subtle d-flex justify-content-between">
                            <span class="fw-bold small font-monospace">@patch.Path</span>
                            <span class="badge border fw-normal">@patch.LinesAdded additions / @patch.LinesDeleted deletions</span>
                        </div>
                        <div class="card-body p-0">
                            @if (diffViewMode == "unified")
                            {
                                <div class="diff-container font-monospace" style="font-size: 12px; line-height: 1.4; overflow-x: auto;">
                                    @foreach (var row in GetUnifiedDiffRows(patch.DiffLines))
                                    {
                                        <div class="diff-line d-flex @row.CssClass">
                                            <div class="diff-linenum text-end border-end user-select-none" style="width: 45px; min-width: 45px; padding: 0 6px; color: #8b949e;">@row.OldNum</div>
                                            <div class="diff-linenum text-end border-end user-select-none" style="width: 45px; min-width: 45px; padding: 0 6px; color: #8b949e;">@row.NewNum</div>
                                            <div class="diff-sign px-1 text-center user-select-none" style="width: 20px; min-width: 20px;">@row.Sign</div>
                                            <div class="diff-text px-2 text-wrap flex-grow-1" style="white-space: pre-wrap;">@row.Content</div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="diff-container font-monospace border-top" style="font-size: 12px; line-height: 1.4; overflow-x: auto;">
                                    @foreach (var pair in GetSplitDiffWithLineNumbers(patch.DiffLines))
                                    {
                                        <div class="d-flex border-bottom">
                                            <div class="col-6 diff-line border-end @(pair.Left?.StartsWith("-") == true ? "diff-removed" : pair.Left == null && pair.Right?.StartsWith("+") == true ? "diff-empty" : "diff-context")">
                                                <div class="d-flex h-100">
                                                    <div class="diff-linenum text-end border-end user-select-none" style="width: 40px; min-width: 40px; padding: 0 4px; color: #8b949e;">@(pair.LeftLineNum > 0 ? pair.LeftLineNum.ToString() : "")</div>
                                                    <div class="diff-sign px-1 text-center user-select-none" style="width: 20px; min-width: 20px;">@(pair.Left?.Length > 0 ? pair.Left[0] : ' ')</div>
                                                    <div class="diff-text px-2 text-wrap flex-grow-1" style="white-space: pre-wrap;">@(pair.Left?.Length > 0 ? pair.Left.Substring(1) : "")</div>
                                                </div>
                                            </div>
                                            <div class="col-6 diff-line @(pair.Right?.StartsWith("+") == true ? "diff-added" : pair.Right == null && pair.Left?.StartsWith("-") == true ? "diff-empty" : "diff-context")">
                                                <div class="d-flex h-100">
                                                    <div class="diff-linenum text-end border-end user-select-none" style="width: 40px; min-width: 40px; padding: 0 4px; color: #8b949e;">@(pair.RightLineNum > 0 ? pair.RightLineNum.ToString() : "")</div>
                                                    <div class="diff-sign px-1 text-center user-select-none" style="width: 20px; min-width: 20px;">@(pair.Right?.Length > 0 ? pair.Right[0] : ' ')</div>
                                                    <div class="diff-text px-2 text-wrap flex-grow-1" style="white-space: pre-wrap;">@(pair.Right?.Length > 0 ? pair.Right.Substring(1) : "")</div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </div>
}

@if (showDeleteModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title fw-bold">Delete file</h5>
                    <button type="button" class="btn-close shadow-none" @onclick="() => showDeleteModal = false"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete <strong>@Path</strong>?</p>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-light btn-sm border px-3" @onclick="() => showDeleteModal = false">Cancel</button>
                    <button type="button" class="btn btn-danger btn-sm shadow-sm" @onclick="DeleteFileCommit">Delete file</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showDeleteRepoModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow border-danger border-opacity-25">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title fw-bold text-danger">Delete repository</h5>
                    <button type="button" class="btn-close shadow-none" @onclick="() => showDeleteRepoModal = false"></button>
                </div>
                <div class="modal-body">
                    <p>Permanently delete <strong>@RepoName</strong>?</p>
                    <input type="text" class="form-control shadow-none mt-2" @bind="deleteConfirmName" @bind:event="oninput" placeholder="@RepoName" />
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-light btn-sm border px-3" @onclick="() => showDeleteRepoModal = false">Cancel</button>
                    <button type="button" class="btn btn-danger btn-sm shadow-sm" @onclick="DeleteRepository" disabled="@(deleteConfirmName != RepoName)">Delete</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showNewBranchModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title fw-bold">Create branch</h5>
                    <button type="button" class="btn-close shadow-none" @onclick="() => showNewBranchModal = false"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control shadow-none" @bind="newBranchName" @bind:event="oninput" placeholder="branch-name" />
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-light btn-sm border px-3" @onclick="() => showNewBranchModal = false">Cancel</button>
                    <button type="button" class="btn btn-gh-primary btn-sm shadow-sm" @onclick="CreateBranch" disabled="@string.IsNullOrWhiteSpace(newBranchName)">Create</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showNewTagModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1050;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-bottom-0">
                    <h5 class="modal-title fw-bold">Create tag</h5>
                    <button type="button" class="btn-close shadow-none" @onclick="() => showNewTagModal = false"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control shadow-none" @bind="newTagName" @bind:event="oninput" placeholder="v1.0" />
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-light btn-sm border px-3" @onclick="() => showNewTagModal = false">Cancel</button>
                    <button type="button" class="btn btn-gh-primary btn-sm shadow-sm" @onclick="CreateTag" disabled="@string.IsNullOrWhiteSpace(newTagName)">Create</button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .nav-tabs .nav-link {
        border: none;
        padding: 0.5rem 1rem;
        border-bottom: 2px solid transparent;
        border-radius: 0;
    }

        .nav-tabs .nav-link.active {
            border-bottom: 2px solid #fd7e14;
            background: transparent;
        }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "/";
    }

    .list-group-item:hover {
        background-color: #f6f8fa;
    }

    .commit-item::before {
        content: "";
        position: absolute;
        left: -30px;
        top: 18px;
        width: 15px;
        height: 1px;
        background-color: #dee2e6;
    }

    pre, .font-monospace {
        font-family: ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;
    }

    .diff-added {
        background-color: var(--diff-added-bg, #e6ffec);
        color: var(--diff-added-fg, #1f883d);
    }

    .diff-removed {
        background-color: var(--diff-removed-bg, #fff1f0);
        color: var(--diff-removed-fg, #cf222e);
    }

    .diff-context {
        background-color: var(--diff-context-bg, white);
        color: var(--diff-context-fg, #1f2328);
    }

    .diff-empty {
        background-color: var(--diff-empty-bg, #f6f8fa);
    }

    .diff-line {
        border-bottom: 1px solid var(--gh-border, #f0f0f0);
        min-height: 20px;
    }

    .diff-sign {
        opacity: 0.6;
    }

    /* Markdown Styles */
    .markdown-body h1, .markdown-body h2 {
        border-bottom: 1px solid #d0d7de;
        padding-bottom: 0.3em;
        margin-top: 24px;
        margin-bottom: 16px;
        font-weight: 600;
        line-height: 1.25;
    }

    .markdown-body h3 {
        margin-top: 24px;
        margin-bottom: 16px;
        font-weight: 600;
        line-height: 1.25;
    }

    .markdown-body p {
        margin-top: 0;
        margin-bottom: 16px;
    }

    .markdown-body ul {
        padding-left: 2em;
        margin-bottom: 16px;
        list-style-type: disc;
    }

    .markdown-body code {
        padding: 0.2em 0.4em;
        margin: 0;
        font-size: 85%;
        background-color: rgba(175,184,193,0.2);
        border-radius: 6px;
        font-family: ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace;
    }

    .markdown-body blockquote {
        padding: 0 1em;
        color: #656d76;
        border-left: 0.25em solid #d0d7de;
        margin: 0 0 16px 0;
    }

    .markdown-body table {
        display: block;
        width: max-content;
        max-width: 100%;
        overflow: auto;
        border-spacing: 0;
        border-collapse: collapse;
        margin-bottom: 16px;
    }

        .markdown-body table tr {
            background-color: #ffffff;
            border-top: 1px solid #d8dee4;
        }

            .markdown-body table tr:nth-child(2n) {
                background-color: #f6f8fa;
            }

        .markdown-body table th, .markdown-body table td {
            padding: 6px 13px;
            border: 1px solid #d0d7de;
        }

    .markdown-body img {
        max-width: 100%;
        box-sizing: content-box;
        background-color: #ffffff;
    }

    .markdown-body hr {
        height: 0.25em;
        padding: 0;
        margin: 24px 0;
        background-color: #d0d7de;
        border: 0;
    }

    .markdown-body pre {
        padding: 16px;
        overflow: auto;
        font-size: 85%;
        line-height: 1.45;
        background-color: #f6f8fa;
        border-radius: 6px;
        margin-bottom: 16px;
        word-wrap: normal;
    }

    .markdown-body pre code {
        padding: 0;
        margin: 0;
        font-size: 100%;
        background-color: transparent;
        border-radius: 0;
        white-space: pre;
        word-break: normal;
        display: inline;
        max-width: auto;
        overflow: visible;
        line-height: inherit;
    }

    .markdown-body ol {
        padding-left: 2em;
        margin-bottom: 16px;
        list-style-type: decimal;
    }

    .markdown-body li + li {
        margin-top: 0.25em;
    }

    .markdown-body .task-list-item {
        list-style-type: none;
        margin-left: -1.5em;
    }

    .markdown-body .task-list-item input[type="checkbox"] {
        margin-right: 0.5em;
    }

    .markdown-body h4, .markdown-body h5, .markdown-body h6 {
        margin-top: 24px;
        margin-bottom: 16px;
        font-weight: 600;
        line-height: 1.25;
    }

    .markdown-body a {
        color: #0969da;
        text-decoration: none;
    }

    .markdown-body a:hover {
        text-decoration: underline;
    }

    .markdown-body dl {
        padding: 0;
        margin-bottom: 16px;
    }

    .markdown-body dl dt {
        padding: 0;
        margin-top: 16px;
        font-weight: 600;
    }

    .markdown-body dl dd {
        padding: 0 16px;
        margin-bottom: 16px;
    }

    .markdown-body sup {
        font-size: 75%;
        line-height: 0;
        position: relative;
        vertical-align: baseline;
        top: -0.5em;
    }

    .markdown-body .footnotes {
        font-size: 85%;
        border-top: 1px solid #d0d7de;
        margin-top: 24px;
        padding-top: 16px;
    }

    .upload-zone {
        border: 2px dashed #d0d7de;
        border-radius: 8px;
        padding: 20px;
        transition: all 0.3s ease;
        background-color: #f6f8fa;
    }

    .upload-zone.dragging {
        border-color: #0969da;
        background-color: #ddf4ff;
    }

    .upload-zone:hover {
        border-color: #0969da;
    }

    /* Prism.js overrides for GitHub-like appearance */
    pre[class*="language-"] {
        background: #ffffff !important;
        margin: 0 !important;
        border-radius: 0 !important;
    }

    code[class*="language-"] {
        font-family: ui-monospace,SFMono-Regular,SF Mono,Menlo,Consolas,Liberation Mono,monospace !important;
        font-size: 13px !important;
    }

    .line-numbers .line-numbers-rows {
        border-right: 1px solid #e1e4e8 !important;
        padding-right: 8px;
    }

    .line-numbers .line-numbers-rows > span:before {
        color: #8b949e !important;
    }

    .diff-linenum {
        font-size: 11px;
        line-height: inherit;
    }

    .diff-hunk .diff-text {
        font-style: italic;
        font-size: 11px;
    }

    .editor-wrapper textarea {
        background: transparent;
    }

    .editor-wrapper textarea:focus {
        box-shadow: none;
        outline: none;
    }

    .line-numbers-gutter {
        pointer-events: none;
        z-index: 1;
    }

    /* Dark mode overrides */
    [data-bs-theme="dark"] .list-group-item:hover {
        background-color: #161b22;
    }

    [data-bs-theme="dark"] .markdown-body h1,
    [data-bs-theme="dark"] .markdown-body h2 {
        border-bottom-color: #30363d;
    }

    [data-bs-theme="dark"] .markdown-body blockquote {
        color: #8b949e;
        border-left-color: #30363d;
    }

    [data-bs-theme="dark"] .markdown-body table tr {
        background-color: #0d1117;
        border-top-color: #30363d;
    }

    [data-bs-theme="dark"] .markdown-body table tr:nth-child(2n) {
        background-color: #161b22;
    }

    [data-bs-theme="dark"] .markdown-body table th,
    [data-bs-theme="dark"] .markdown-body table td {
        border-color: #30363d;
    }

    [data-bs-theme="dark"] .markdown-body img {
        background-color: transparent;
    }

    [data-bs-theme="dark"] .markdown-body hr {
        background-color: #30363d;
    }

    [data-bs-theme="dark"] .markdown-body code {
        background-color: rgba(110,118,129,0.4);
    }

    [data-bs-theme="dark"] .markdown-body pre {
        background-color: #161b22;
    }

    [data-bs-theme="dark"] .markdown-body a {
        color: #58a6ff;
    }

    [data-bs-theme="dark"] .markdown-body .footnotes {
        border-top-color: #30363d;
    }

    [data-bs-theme="dark"] pre[class*="language-"] {
        background: #0d1117 !important;
        color: #e6edf3 !important;
    }

    [data-bs-theme="dark"] .line-numbers .line-numbers-rows {
        border-right-color: #30363d !important;
    }

    [data-bs-theme="dark"] .diff-linenum {
        color: #8b949e;
    }

    [data-bs-theme="dark"] .upload-zone {
        border-color: #30363d;
        background-color: #161b22;
    }

    [data-bs-theme="dark"] .upload-zone.dragging {
        border-color: #58a6ff;
        background-color: #0d2137;
    }

    [data-bs-theme="dark"] .upload-zone:hover {
        border-color: #58a6ff;
    }

    [data-bs-theme="dark"] .commit-item::before {
        background-color: #30363d;
    }
</style>

@if (showUploadModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload files to @RepoName</h5>
                    <button type="button" class="btn-close" @onclick="() => showUploadModal = false"></button>
                </div>
                <div class="modal-body">
                    <div class="upload-zone @(isDragging ? "dragging" : "")"
                         @ondrop="HandleDrop"
                         @ondrop:preventDefault
                         @ondragover="HandleDragOver"
                         @ondragover:preventDefault
                         @ondragenter="HandleDragEnter"
                         @ondragenter:preventDefault
                         @ondragleave="HandleDragLeave">
                        <div class="text-center py-5">
                            <i class="bi bi-cloud-upload display-1 text-muted mb-3"></i>
                            <h5>Drag and drop files here</h5>
                            <p class="text-muted">or</p>
                            <label for="fileInput" class="btn btn-primary">
                                Choose files
                            </label>
                            <InputFile id="fileInput" OnChange="HandleFileSelected" multiple class="d-none" />
                        </div>
                        @if (uploadFiles.Any())
                        {
                            <div class="mt-3">
                                <h6>Selected files:</h6>
                                <ul class="list-group">
                                    @foreach (var file in uploadFiles)
                                    {
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            <span><i class="bi bi-file-earmark me-2"></i>@file.Name</span>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveUploadFile(file)">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </li>
                                    }
                                </ul>
                            </div>
                        }
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Commit message</label>
                        <input type="text" class="form-control" @bind="uploadCommitMessage" placeholder="Add files via upload" />
                    </div>
                    @if (!string.IsNullOrEmpty(uploadError))
                    {
                        <div class="alert alert-danger mt-3">@uploadError</div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showUploadModal = false">Cancel</button>
                    <button type="button" class="btn btn-success" @onclick="CommitUploadedFiles" disabled="@(!uploadFiles.Any())">
                        <i class="bi bi-upload me-1"></i>Commit changes
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@if (showFolderUploadModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload folder to @RepoName</h5>
                    <button type="button" class="btn-close" @onclick="() => showFolderUploadModal = false"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center py-4 border rounded mb-3 bg-light">
                        <i class="bi bi-folder-plus display-4 text-muted mb-3"></i>
                        <h5>Select a folder to upload</h5>
                        <p class="text-muted small">All files in the folder will be added to the repository</p>
                        <label for="folderInput" class="btn btn-primary">
                            <i class="bi bi-folder2-open me-1"></i>Choose folder
                        </label>
                        <InputFile id="folderInput" OnChange="HandleFolderSelected" multiple class="d-none" />
                    </div>
                    @if (folderBrowserFiles.Any())
                    {
                        <div class="alert alert-info py-2">
                            <i class="bi bi-folder me-2"></i><strong>@folderBrowserFiles.Count</strong> files to upload
                        </div>
                        @if (!string.IsNullOrEmpty(folderUploadInfo))
                        {
                            <div class="alert alert-secondary py-2 small">
                                <i class="bi bi-funnel me-1"></i>@folderUploadInfo
                            </div>
                        }
                        <div style="max-height: 250px; overflow-y: auto;">
                            <ul class="list-group list-group-flush">
                                @foreach (var entry in folderFilePaths)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-1 px-2">
                                        <span class="small text-truncate" style="max-width: 80%;">
                                            <i class="bi bi-file-earmark me-1"></i>@entry.Value
                                        </span>
                                        <span class="badge bg-light text-muted">@FormatFileSize(folderBrowserFiles[entry.Key].Size)</span>
                                    </li>
                                }
                            </ul>
                        </div>
                    }
                    @if (folderUploading)
                    {
                        <div class="mt-3">
                            <div class="d-flex align-items-center mb-1">
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span class="small">Uploading... @folderUploadProgress%</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: @(folderUploadProgress)%"></div>
                            </div>
                        </div>
                    }
                    <div class="mt-3">
                        <label class="form-label">Commit message</label>
                        <input type="text" class="form-control" @bind="folderUploadCommitMessage" placeholder="Add folder via upload" />
                    </div>
                    @if (!string.IsNullOrEmpty(folderUploadError))
                    {
                        <div class="alert alert-danger mt-3">@folderUploadError</div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => showFolderUploadModal = false" disabled="@folderUploading">Cancel</button>
                    <button type="button" class="btn btn-success" @onclick="CommitFolderUpload" disabled="@(!folderBrowserFiles.Any() || folderUploading)">
                        <i class="bi bi-folder-plus me-1"></i>Commit folder
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public string RepoName { get; set; } = "";
    [Parameter] public string? Path { get; set; }
    [Parameter] public string? CommitHash { get; set; }

    private string activeTab = "code";
    private bool notFound = false;
    private bool isEmpty = true;
    private bool isFile = false;
    private string currentBranch = "main";
    private int commitCount = 0;
    private string diffViewMode = "unified";
    private string fileSearchTerm = "";
    private bool showRaw = false;

    private List<TreeItem> treeItems = new();
    private List<GitCommit> commitHistory = new();
    private List<BranchSummary> branches = new();
    private List<TagSummary> tags = new();
    private GitCommit? latestCommit;

    private string fileContent = "";
    private long fileSize = 0;
    private int lineCount = 0;
    private string readmeContent = "";
    private List<LanguageStat> languageStats = new();

    // UI States
    private string editingContent = "";
    private string commitMessage = "";
    private string commitDescription = "";
    private string newFileName = "";
    private string editorMode = "edit"; // "edit" or "preview"
    private bool showDeleteModal = false;
    private bool showNewBranchModal = false;
    private bool showBranchDropdown = false;
    private bool showNewTagModal = false;
    private bool showDeleteRepoModal = false;
    private bool showCloneDropdown = false;
    private bool showUploadModal = false;
    private string newBranchName = "";
    private string newTagName = "";
    private string deleteConfirmName = "";

    private bool isDragging = false;
    private List<IBrowserFile> uploadFiles = new();
    private string uploadCommitMessage = "Add files via upload";
    private string uploadError = "";
    private const long maxFileSize = 1024 * 1024 * 50;

    // Folder upload
    private bool showFolderUploadModal = false;
    private string folderUploadCommitMessage = "Add folder via upload";
    private string folderUploadError = "";
    private string folderUploadInfo = "";
    private List<IBrowserFile> folderBrowserFiles = new();
    private Dictionary<int, string> folderFilePaths = new();
    private bool folderUploading = false;
    private int folderUploadProgress = 0;

    // Default ignored patterns (common build artifacts, VCS dirs, etc.)
    private static readonly string[] DefaultIgnorePatterns = new[]
    {
        ".git/", ".git\\",
        "bin/", "bin\\",
        "obj/", "obj\\",
        "node_modules/", "node_modules\\",
        ".vs/", ".vs\\",
        ".idea/", ".idea\\",
        "__pycache__/", "__pycache__\\",
        ".DS_Store",
        "Thumbs.db",
        "*.suo", "*.user", "*.userosscache", "*.sln.docstates",
        "packages/", "packages\\",
        "dist/", "dist\\",
        "build/", "build\\",
        ".next/", ".next\\",
        "target/", "target\\",
        "*.exe", "*.dll", "*.pdb", "*.cache",
    };

    private static bool ShouldIgnoreFile(string relativePath, List<string> gitignorePatterns)
    {
        var normalized = relativePath.Replace('\\', '/');
        var segments = normalized.Split('/');

        // Check default ignore patterns
        foreach (var pattern in DefaultIgnorePatterns)
        {
            var p = pattern.Replace('\\', '/');
            if (p.EndsWith("/"))
            {
                // Directory pattern — check if any path segment matches
                var dirName = p.TrimEnd('/');
                if (segments.Any(s => s.Equals(dirName, StringComparison.OrdinalIgnoreCase)))
                    return true;
            }
            else if (p.StartsWith("*."))
            {
                // Extension pattern
                var ext = p.Substring(1); // e.g., ".exe"
                if (normalized.EndsWith(ext, StringComparison.OrdinalIgnoreCase))
                    return true;
            }
            else
            {
                // Exact filename
                var fileName = segments.Last();
                if (fileName.Equals(p, StringComparison.OrdinalIgnoreCase))
                    return true;
            }
        }

        // Check .gitignore patterns from the uploaded folder
        foreach (var pattern in gitignorePatterns)
        {
            var p = pattern.Trim();
            if (string.IsNullOrEmpty(p) || p.StartsWith("#")) continue;

            var cleanPattern = p.TrimEnd('/');
            if (p.EndsWith("/"))
            {
                // Directory pattern
                if (segments.Any(s => s.Equals(cleanPattern, StringComparison.OrdinalIgnoreCase)))
                    return true;
            }
            else if (p.StartsWith("*."))
            {
                var ext = p.Substring(1);
                if (normalized.EndsWith(ext, StringComparison.OrdinalIgnoreCase))
                    return true;
            }
            else if (p.Contains('/'))
            {
                // Path pattern
                if (normalized.StartsWith(cleanPattern, StringComparison.OrdinalIgnoreCase) ||
                    normalized.Contains("/" + cleanPattern, StringComparison.OrdinalIgnoreCase))
                    return true;
            }
            else
            {
                // Match as directory name or filename
                if (segments.Any(s => s.Equals(cleanPattern, StringComparison.OrdinalIgnoreCase)))
                    return true;
            }
        }

        return false;
    }

    private GitCommit? selectedCommit;
    private List<FilePatch> commitPatches = new();

    // Blame view state
    private List<BlameLine> blameLines = new();

    private class BlameLine
    {
        public int HunkIndex { get; set; }
        public int HunkLineCount { get; set; }
        public bool IsFirstInHunk { get; set; }
        public string CommitSha { get; set; } = "";
        public string ShortSha { get; set; } = "";
        public string Author { get; set; } = "";
        public DateTime Date { get; set; }
        public int LineNumber { get; set; }
        public string Content { get; set; } = "";
    }

    private void ExitBlameView() { activeTab = "code"; LoadRepoData(); }

    // Commit graph state
    private List<GraphEntry> graphEntries = new();
    private int graphMaxLane = 0;
    private static readonly string[] GraphColors = new[] { "#0969da", "#cf222e", "#1a7f37", "#8250df", "#bf8700", "#0550ae", "#e16f24", "#6639ba" };

    private class GraphEntry
    {
        public int Row { get; set; }
        public int Lane { get; set; }
        public string Sha { get; set; } = "";
        public string ShortSha { get; set; } = "";
        public string Message { get; set; } = "";
        public string Author { get; set; } = "";
        public DateTime Date { get; set; }
        public string Color { get; set; } = "";
        public List<int> ParentRows { get; set; } = new();
    }

    private void LoadGraph()
    {
        graphEntries.Clear();
        graphMaxLane = 0;
        try
        {
            using var repo = new Repository(RepoFullPath);
            var shaToRow = new Dictionary<string, int>();
            var activeLanes = new Dictionary<string, int>(); // sha -> lane
            int row = 0;
            int nextLane = 0;

            // Collect commits from all branches
            var allTips = repo.Branches.Select(b => b.Tip).Where(t => t != null).ToList();
            if (!allTips.Any()) return;

            var filter = new CommitFilter { IncludeReachableFrom = allTips, SortBy = CommitSortStrategies.Topological | CommitSortStrategies.Time };
            var commits = repo.Commits.QueryBy(filter).Take(100).ToList();

            // Assign branch colors
            var branchColors = new Dictionary<string, string>();
            int colorIdx = 0;
            foreach (var branch in repo.Branches)
            {
                if (branch.Tip != null)
                    branchColors[branch.Tip.Sha] = GraphColors[colorIdx++ % GraphColors.Length];
            }

            foreach (var commit in commits)
            {
                // Determine lane for this commit
                int lane;
                if (activeLanes.ContainsKey(commit.Sha))
                {
                    lane = activeLanes[commit.Sha];
                    activeLanes.Remove(commit.Sha);
                }
                else
                {
                    lane = nextLane++;
                }

                var color = branchColors.ContainsKey(commit.Sha) ? branchColors[commit.Sha] : GraphColors[lane % GraphColors.Length];
                shaToRow[commit.Sha] = row;

                var entry = new GraphEntry
                {
                    Row = row,
                    Lane = lane,
                    Sha = commit.Sha,
                    ShortSha = commit.Sha[..7],
                    Message = commit.MessageShort,
                    Author = commit.Author.Name,
                    Date = commit.Author.When.DateTime,
                    Color = color
                };

                // Link parents
                foreach (var parent in commit.Parents)
                {
                    if (shaToRow.ContainsKey(parent.Sha))
                    {
                        entry.ParentRows.Add(shaToRow[parent.Sha]);
                    }
                    if (!activeLanes.ContainsKey(parent.Sha))
                    {
                        activeLanes[parent.Sha] = lane;
                    }
                }

                graphEntries.Add(entry);
                if (lane > graphMaxLane) graphMaxLane = lane;
                row++;
            }
        }
        catch { }
    }

    private string TruncateMessage(string msg, int max)
    {
        return msg.Length <= max ? msg : msg[..max] + "...";
    }

    private void ToggleBlameView()
    {
        if (activeTab == "blame")
        {
            activeTab = "code";
            LoadRepoData();
            return;
        }
        activeTab = "blame";
        LoadBlame();
    }

    private void LoadBlame()
    {
        blameLines.Clear();
        if (string.IsNullOrEmpty(Path)) return;
        try
        {
            using var repo = new Repository(RepoFullPath);
            var result = repo.Blame(Path);
            var allLines = fileContent.Split('\n');
            int hunkIndex = 0;
            foreach (var hunk in result)
            {
                var lineCount = hunk.LineCount;
                for (int i = 0; i < lineCount; i++)
                {
                    var globalLine = hunk.FinalStartLineNumber + i;
                    blameLines.Add(new BlameLine
                    {
                        HunkIndex = hunkIndex,
                        HunkLineCount = lineCount,
                        IsFirstInHunk = i == 0,
                        CommitSha = hunk.FinalCommit.Sha,
                        ShortSha = hunk.FinalCommit.Sha[..7],
                        Author = hunk.FinalCommit.Author.Name,
                        Date = hunk.FinalCommit.Author.When.DateTime,
                        LineNumber = globalLine + 1,
                        Content = globalLine < allLines.Length ? allLines[globalLine] : ""
                    });
                }
                hunkIndex++;
            }
        }
        catch { }
    }

    // Repository metadata (from DB)
    private bool repoIsPrivate = false;
    private string repoDescription = "";
    private string repoOwner = "";
    private string repoForkedFrom = "";
    private bool repoIsForked = false;
    private int repoForkCount = 0;

    // Settings tab state
    private bool settingsIsPrivate = false;
    private string settingsDescription = "";
    private string settingsSaveMessage = "";

    // Collaborators state
    private List<MyPersonalGit.Models.RepositoryCollaborator> collaborators = new();
    private string newCollaboratorUsername = "";
    private string newCollaboratorPermission = "Read";

    // Releases state
    private List<MyPersonalGit.Models.Release> releases = new();
    private bool showCreateRelease = false;
    private string newReleaseTagName = "";
    private string newReleaseTitle = "";
    private string newReleaseBody = "";
    private bool newReleaseIsDraft = false;
    private bool newReleaseIsPrerelease = false;
    private string releaseError = "";
    private bool assetUploading = false;
    private string assetUploadError = "";

    // Branch protection
    private List<BranchProtectionRule> branchProtectionRules = new();
    private bool showAddProtectionRule = false;
    private BranchProtectionRule newProtectionRule = new() { BranchPattern = "" };

    private string RootPath = "/repos";
    private string RepoFullPath => GetRepoFullPath();

    private string GetRepoFullPath()
    {
        var path = System.IO.Path.Combine(RootPath, RepoName);
        if (Repository.IsValid(path)) return path;
        if (Repository.IsValid(path + ".git")) return path + ".git";
        // Check for nested repo (e.g., /repos/RepoName/RepoName.git)
        var nested = System.IO.Path.Combine(path, RepoName + ".git");
        if (Repository.IsValid(nested)) return nested;
        return path;
    }

    private string CloneUrl => $"{Nav.BaseUri.TrimEnd('/')}/git/{RepoName}.git";

    protected override async Task OnParametersSetAsync()
    {
        // Priority: 1) Admin UI saved setting, 2) appsettings config, 3) auto-detection
        var systemSettings = await AdminService.GetSystemSettingsAsync();
        if (!string.IsNullOrEmpty(systemSettings.ProjectRoot))
        {
            try
            {
                if (!Directory.Exists(systemSettings.ProjectRoot))
                    Directory.CreateDirectory(systemSettings.ProjectRoot);
                RootPath = systemSettings.ProjectRoot;
            }
            catch { /* path invalid or drive missing — fall through */ }
        }

        if (string.IsNullOrEmpty(RootPath))
        {
            var configuredPath = Config["Git:ProjectRoot"];
            if (!string.IsNullOrEmpty(configuredPath))
            {
                try
                {
                    if (!Directory.Exists(configuredPath))
                        Directory.CreateDirectory(configuredPath);
                    RootPath = configuredPath;
                }
                catch { /* fall through */ }
            }
        }

        LoadRepoData();
        await LoadRepoMetadata();
    }

    private async Task LoadRepoMetadata()
    {
        var repoName = RepoFullPath;
        var dirName = System.IO.Path.GetFileName(repoName);
        var meta = await RepoService.GetRepositoryAsync(dirName);
        if (meta != null)
        {
            repoIsPrivate = meta.IsPrivate;
            repoDescription = meta.Description ?? "";
            repoOwner = meta.Owner;
            repoForkedFrom = meta.ForkedFrom ?? "";
            repoForkCount = meta.Forks;
            settingsIsPrivate = meta.IsPrivate;
            settingsDescription = meta.Description ?? "";
        }
        else
        {
            repoIsPrivate = false;
            repoDescription = "";
            repoOwner = "";
            repoForkedFrom = "";
            repoForkCount = 0;
            settingsIsPrivate = false;
            settingsDescription = "";
        }

        // Check if current user already forked this repo
        if (UserService.IsLoggedIn)
            repoIsForked = await RepoService.IsForkedAsync(dirName, UserService.Username);

        // Enforce private repo access: if private and user is not owner or collaborator, block
        if (repoIsPrivate)
        {
            var hasAccess = UserService.IsLoggedIn && (
                repoOwner.Equals(UserService.Username, StringComparison.OrdinalIgnoreCase) ||
                await CollaboratorService.IsCollaboratorAsync(dirName, UserService.Username));
            if (!hasAccess)
                notFound = true;
        }
    }

    private async Task SaveGeneralSettings()
    {
        settingsSaveMessage = "";
        var dirName = System.IO.Path.GetFileName(RepoFullPath);
        await RepoService.EnsureRepositoryRecordAsync(dirName, UserService.Username);
        await RepoService.UpdateRepositoryAsync(dirName, repo =>
        {
            repo.Description = settingsDescription;
            repo.IsPrivate = settingsIsPrivate;
        });
        repoIsPrivate = settingsIsPrivate;
        repoDescription = settingsDescription;
        settingsSaveMessage = "Settings saved!";
        StateHasChanged();
    }

    private async Task LoadCollaborators()
    {
        var dirName = System.IO.Path.GetFileName(RepoFullPath);
        collaborators = await CollaboratorService.GetCollaboratorsAsync(dirName);
    }

    private async Task AddCollaborator()
    {
        if (string.IsNullOrWhiteSpace(newCollaboratorUsername)) return;
        var dirName = System.IO.Path.GetFileName(RepoFullPath);
        var perm = Enum.Parse<MyPersonalGit.Models.CollaboratorPermission>(newCollaboratorPermission);
        await CollaboratorService.AddCollaboratorAsync(dirName, newCollaboratorUsername, perm, UserService.Username);
        newCollaboratorUsername = "";
        await LoadCollaborators();
    }

    private async Task RemoveCollaborator(string username)
    {
        var dirName = System.IO.Path.GetFileName(RepoFullPath);
        await CollaboratorService.RemoveCollaboratorAsync(dirName, username);
        await LoadCollaborators();
    }

    private async Task LoadReleases()
    {
        var dirName = System.IO.Path.GetFileName(RepoFullPath);
        releases = await ReleaseService.GetReleasesAsync(dirName);
    }

    private async Task CreateRelease()
    {
        releaseError = "";
        if (string.IsNullOrWhiteSpace(newReleaseTagName)) { releaseError = "Please select a tag."; return; }
        if (string.IsNullOrWhiteSpace(newReleaseTitle)) { releaseError = "Please enter a title."; return; }

        var dirName = System.IO.Path.GetFileName(RepoFullPath);
        await ReleaseService.CreateReleaseAsync(dirName, newReleaseTagName, newReleaseTitle, newReleaseBody, UserService.Username, newReleaseIsDraft, newReleaseIsPrerelease);
        newReleaseTagName = "";
        newReleaseTitle = "";
        newReleaseBody = "";
        newReleaseIsDraft = false;
        newReleaseIsPrerelease = false;
        showCreateRelease = false;
        await LoadReleases();
    }

    private async Task DeleteRelease(int releaseId)
    {
        var dirName = System.IO.Path.GetFileName(RepoFullPath);
        await ReleaseService.DeleteReleaseAsync(dirName, releaseId);
        await LoadReleases();
    }

    private async Task HandleAssetUpload(InputFileChangeEventArgs e, int releaseId)
    {
        assetUploadError = "";
        assetUploading = true;
        StateHasChanged();
        try
        {
            foreach (var file in e.GetMultipleFiles(10))
            {
                if (file.Size > maxFileSize) { assetUploadError = $"File {file.Name} exceeds 50MB limit."; continue; }
                using var stream = file.OpenReadStream(maxFileSize);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                await ReleaseService.AddAssetAsync(releaseId, file.Name, file.Size, file.ContentType, ms.ToArray());
            }
            await LoadReleases();
        }
        catch (Exception ex)
        {
            assetUploadError = $"Upload failed: {ex.Message}";
        }
        assetUploading = false;
    }

    private async Task DeleteAsset(int assetId, int releaseId)
    {
        await ReleaseService.DeleteAssetAsync(assetId);
        await LoadReleases();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (isFile && !showRaw)
        {
            await JS.InvokeVoidAsync("Prism.highlightAll");
        }
        if (showFolderUploadModal)
        {
            try { await JS.InvokeVoidAsync("folderUpload.setWebkitDirectory", "folderInput"); } catch { }
        }
        if ((activeTab == "edit" || activeTab == "add-file") && editorMode == "edit")
        {
            try { await JS.InvokeVoidAsync("editorHelper.enableTabKey", "codeEditor"); } catch { }
        }
    }

    private string GetPageTitle()
    {
        if (activeTab == "edit") return $"Editing {System.IO.Path.GetFileName(Path)}";
        if (activeTab == "add-file") return "Adding new file";
        return string.IsNullOrEmpty(Path) ? RepoName : System.IO.Path.GetFileName(Path);
    }

    private async Task SetTab(string tab)
    {
        activeTab = tab;
        if (tab == "code" && string.IsNullOrEmpty(Path)) Nav.NavigateTo($"/repo/{RepoName}");
        else LoadRepoData();
        if (tab == "settings" || tab == "branches") await LoadBranchProtectionRules();
        if (tab == "settings") await LoadCollaborators();
        if (tab == "releases") await LoadReleases();
        if (tab == "graph") LoadGraph();
    }

    private void LoadRepoData()
    {
        var fullPath = RepoFullPath;
        if (!Repository.IsValid(fullPath)) { notFound = true; return; }

        try
        {
            using var repo = new Repository(fullPath);
            isEmpty = !repo.Refs.Any() && !repo.Commits.Any();
            notFound = false;

            branches = repo.Branches.Select(b => new BranchSummary { Name = b.FriendlyName, IsCurrent = b.IsCurrentRepositoryHead }).ToList();
            tags = repo.Tags.Select(t => new TagSummary { Name = t.FriendlyName, TargetSha = t.Target.Sha }).ToList();

            var branch = repo.Branches[currentBranch] ?? repo.Branches["main"] ?? repo.Branches["master"] ?? repo.Head;
            currentBranch = branch.FriendlyName;

            if (branch.Tip != null)
            {
                latestCommit = MapCommit(branch.Tip);
                isEmpty = false;

                if (activeTab == "commits")
                {
                    var filter = new CommitFilter { IncludeReachableFrom = branch.Tip };
                    if (isFile && !string.IsNullOrEmpty(Path))
                    {
                        commitHistory = repo.Commits.QueryBy(Path, filter).Select(c => MapCommit(c.Commit)).Take(20).ToList();
                        commitCount = repo.Commits.QueryBy(Path, filter).Count();
                    }
                    else
                    {
                        commitHistory = repo.Commits.QueryBy(filter).Select(c => MapCommit(c)).Take(20).ToList();
                        commitCount = repo.Commits.QueryBy(filter).Count();
                    }
                }

                if (!string.IsNullOrEmpty(CommitHash))
                {
                    activeTab = "commit-detail";
                    var rawCommit = repo.Lookup<Commit>(CommitHash);
                    if (rawCommit != null)
                    {
                        selectedCommit = MapCommit(rawCommit);
                        LoadCommitDetail(repo, rawCommit);
                    }
                }
                else if (string.IsNullOrEmpty(Path))
                {
                    isFile = false;
                    LoadTree(branch.Tip.Tree, repo);
                    LoadReadme(branch.Tip.Tree);
                    LoadLanguageStats(branch.Tip.Tree);
                }
                else
                {
                    var entry = branch.Tip[Path];
                    if (entry == null) { notFound = true; return; }
                    if (entry.TargetType == TreeEntryTargetType.Tree)
                    {
                        isFile = false;
                        LoadTree((Tree)entry.Target, repo);
                        LoadReadme((Tree)entry.Target);
                    }
                    else
                    {
                        isFile = true;
                        var blob = (Blob)entry.Target;
                        fileSize = blob.Size;
                        using var reader = new StreamReader(blob.GetContentStream(), Encoding.UTF8);
                        fileContent = reader.ReadToEnd();
                        lineCount = fileContent.Split('\n').Length;
                    }
                }
            }
            else
            {
                commitCount = 0;
                commitHistory.Clear();
            }
        }
        catch { notFound = true; }
    }

    private GitCommit MapCommit(Commit c) => new GitCommit
    {
        Sha = c.Sha,
        ShortSha = c.Id.ToString(7),
        AuthorName = c.Author.Name,
        Message = c.MessageShort,
        Date = c.Author.When.DateTime
    };

    private static readonly MarkdownPipeline _markdownPipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .Build();

    private MarkupString ConvertMarkdownToHtml(string markdown)
    {
        if (string.IsNullOrWhiteSpace(markdown)) return new MarkupString("");

        var document = Markdown.Parse(markdown, _markdownPipeline);
        RewriteRelativeUrls(document);

        var writer = new StringWriter();
        var renderer = new Markdig.Renderers.HtmlRenderer(writer);
        _markdownPipeline.Setup(renderer);
        renderer.Render(document);
        writer.Flush();
        return new MarkupString(writer.ToString());
    }

    private void RewriteRelativeUrls(MarkdownDocument document)
    {
        // Determine directory context: README at root → "", file like "docs/guide.md" → "docs"
        var currentDir = string.IsNullOrEmpty(Path)
            ? ""
            : (isFile ? GetParentPath() : Path);

        foreach (var node in document.Descendants())
        {
            if (node is LinkInline link && !string.IsNullOrEmpty(link.Url))
            {
                if (IsAbsoluteUrl(link.Url)) continue;

                // Split off fragment/query
                var url = link.Url;
                var fragment = "";
                var hashIdx = url.IndexOf('#');
                if (hashIdx >= 0) { fragment = url[hashIdx..]; url = url[..hashIdx]; }
                var queryIdx = url.IndexOf('?');
                var query = "";
                if (queryIdx >= 0) { query = url[queryIdx..]; url = url[..queryIdx]; }

                if (string.IsNullOrEmpty(url) && !string.IsNullOrEmpty(fragment))
                    continue; // pure anchor link like #heading

                var resolvedPath = ResolveRelativePath(currentDir, url);

                if (link.IsImage)
                {
                    link.Url = $"/raw/{RepoName}/{resolvedPath}?branch={Uri.EscapeDataString(currentBranch)}";
                }
                else
                {
                    link.Url = $"/repo/{RepoName}/{resolvedPath}{fragment}";
                }
            }
        }
    }

    private static bool IsAbsoluteUrl(string url) =>
        url.StartsWith("http://", StringComparison.OrdinalIgnoreCase) ||
        url.StartsWith("https://", StringComparison.OrdinalIgnoreCase) ||
        url.StartsWith("//") ||
        url.StartsWith("mailto:", StringComparison.OrdinalIgnoreCase) ||
        url.StartsWith("data:", StringComparison.OrdinalIgnoreCase);

    private static string ResolveRelativePath(string currentDir, string relativePath)
    {
        if (relativePath.StartsWith("/"))
            return relativePath.TrimStart('/');

        var combined = string.IsNullOrEmpty(currentDir)
            ? relativePath
            : currentDir.TrimEnd('/') + "/" + relativePath;

        var segments = combined.Split('/', StringSplitOptions.RemoveEmptyEntries);
        var result = new Stack<string>();
        foreach (var seg in segments)
        {
            if (seg == ".") continue;
            if (seg == "..") { if (result.Count > 0) result.Pop(); }
            else result.Push(seg);
        }
        return string.Join("/", result.Reverse());
    }

    private void LoadCommitDetail(Repository repo, Commit c)
    {
        commitPatches.Clear();
        var parent = c.Parents.FirstOrDefault();
        var changes = repo.Diff.Compare<Patch>(parent?.Tree, c.Tree);
        foreach (var change in changes)
        {
            commitPatches.Add(new FilePatch
            {
                Path = change.Path,
                LinesAdded = change.LinesAdded,
                LinesDeleted = change.LinesDeleted,
                DiffLines = change.Patch.Split('\n').ToList()
            });
        }
    }

    private void LoadTree(Tree tree, Repository? repo = null)
    {
        treeItems.Clear();
        foreach (var entry in tree)
        {
            var item = new TreeItem { Name = entry.Name, IsDirectory = entry.TargetType == TreeEntryTargetType.Tree };
            treeItems.Add(item);
        }
        treeItems = treeItems.OrderByDescending(i => i.IsDirectory).ThenBy(i => i.Name).ToList();

        // Load per-file commit info in the background to avoid blocking page load
        if (repo != null)
        {
            var repoPath = RepoFullPath;
            var currentPath = Path;
            var items = treeItems.ToList(); // snapshot
            _ = Task.Run(() =>
            {
                try
                {
                    using var bgRepo = new Repository(repoPath);
                    foreach (var item in items)
                    {
                        try
                        {
                            var itemPath = string.IsNullOrEmpty(currentPath) ? item.Name : $"{currentPath}/{item.Name}";
                            var logEntry = bgRepo.Commits.QueryBy(itemPath).FirstOrDefault();
                            if (logEntry != null)
                            {
                                item.LastCommitMessage = logEntry.Commit.MessageShort;
                                item.LastCommitDate = logEntry.Commit.Author.When.DateTime;
                            }
                        }
                        catch { }
                    }
                    InvokeAsync(StateHasChanged);
                }
                catch { }
            });
        }
    }

    private void LoadReadme(Tree tree)
    {
        readmeContent = "";
        var readme = tree.FirstOrDefault(e => e.Name.Equals("README.md", StringComparison.OrdinalIgnoreCase));
        if (readme != null && readme.TargetType == TreeEntryTargetType.Blob)
        {
            using var reader = new StreamReader(((Blob)readme.Target).GetContentStream(), Encoding.UTF8);
            readmeContent = reader.ReadToEnd();
        }
    }

    private void LoadLanguageStats(Tree tree)
    {
        languageStats.Clear();
        var langBytes = new Dictionary<string, long>(StringComparer.OrdinalIgnoreCase);

        void WalkTree(Tree t)
        {
            foreach (var entry in t)
            {
                if (entry.TargetType == TreeEntryTargetType.Tree)
                    WalkTree((Tree)entry.Target);
                else if (entry.TargetType == TreeEntryTargetType.Blob)
                {
                    var ext = System.IO.Path.GetExtension(entry.Name)?.ToLowerInvariant();
                    var lang = GetLanguageFromExtension(ext)
                        ?? GetLanguageFromFileName(entry.Name);
                    if (lang != null)
                    {
                        var blob = (Blob)entry.Target;
                        langBytes.TryGetValue(lang, out var existing);
                        langBytes[lang] = existing + blob.Size;
                    }
                }
            }
        }

        WalkTree(tree);
        if (langBytes.Count == 0) return;

        var total = (double)langBytes.Values.Sum();
        languageStats = langBytes
            .OrderByDescending(kv => kv.Value)
            .Select(kv => new LanguageStat
            {
                Name = kv.Key,
                Percentage = kv.Value / total * 100.0,
                Color = GetLanguageColor(kv.Key)
            })
            .Where(s => s.Percentage >= 0.1)
            .ToList();
    }

    private static string? GetLanguageFromExtension(string? ext) => ext switch
    {
        ".cs" => "C#",
        ".razor" => "HTML",
        ".cshtml" => "HTML",
        ".html" or ".htm" => "HTML",
        ".css" => "CSS",
        ".scss" or ".sass" => "SCSS",
        ".js" => "JavaScript",
        ".jsx" => "JavaScript",
        ".ts" => "TypeScript",
        ".tsx" => "TypeScript",
        ".json" => "JSON",
        ".xml" => "XML",
        ".yaml" or ".yml" => "YAML",
        ".py" => "Python",
        ".java" => "Java",
        ".rb" => "Ruby",
        ".go" => "Go",
        ".rs" => "Rust",
        ".cpp" or ".cc" or ".cxx" => "C++",
        ".c" or ".h" => "C",
        ".php" => "PHP",
        ".swift" => "Swift",
        ".kt" or ".kts" => "Kotlin",
        ".sql" => "SQL",
        ".sh" or ".bash" => "Shell",
        ".ps1" => "PowerShell",
        ".md" or ".markdown" => "Markdown",
        ".dockerfile" => "Dockerfile",
        ".r" => "R",
        ".lua" => "Lua",
        ".dart" => "Dart",
        ".vue" => "Vue",
        ".svelte" => "Svelte",
        _ => null
    };

    private static string? GetLanguageFromFileName(string name) => name.ToLowerInvariant() switch
    {
        "dockerfile" => "Dockerfile",
        "makefile" => "Makefile",
        "cmakelists.txt" => "CMake",
        _ => null
    };

    private static string GetLanguageColor(string lang) => lang switch
    {
        "C#" => "#178600",
        "HTML" => "#e34c26",
        "CSS" => "#563d7c",
        "SCSS" => "#c6538c",
        "JavaScript" => "#f1e05a",
        "TypeScript" => "#3178c6",
        "Python" => "#3572A5",
        "Java" => "#b07219",
        "Ruby" => "#701516",
        "Go" => "#00ADD8",
        "Rust" => "#dea584",
        "C++" => "#f34b7d",
        "C" => "#555555",
        "PHP" => "#4F5D95",
        "Swift" => "#F05138",
        "Kotlin" => "#A97BFF",
        "SQL" => "#e38c00",
        "Shell" => "#89e051",
        "PowerShell" => "#012456",
        "JSON" => "#292929",
        "XML" => "#0060ac",
        "YAML" => "#cb171e",
        "Markdown" => "#083fa1",
        "Dockerfile" => "#384d54",
        "R" => "#198CE7",
        "Lua" => "#000080",
        "Dart" => "#00B4AB",
        "Vue" => "#41b883",
        "Svelte" => "#ff3e00",
        _ => "#8b949e"
    };

    private void ViewFileHistory() { activeTab = "commits"; LoadRepoData(); }
    private void ClearFileFilter() { Path = null; activeTab = "commits"; LoadRepoData(); }
    private void SwitchBranch(string name) { currentBranch = name; Path = null; activeTab = "code"; showBranchDropdown = false; LoadRepoData(); }
    private void EnterEditMode() { editingContent = fileContent; commitMessage = $"Update {System.IO.Path.GetFileName(Path)}"; editorMode = "edit"; activeTab = "edit"; }
    private void EnterAddFileMode() { editingContent = ""; newFileName = ""; commitMessage = "Add file"; editorMode = "edit"; activeTab = "add-file"; }

    private async Task ForkRepository()
    {
        if (!UserService.IsLoggedIn || repoIsForked) return;
        var dirName = System.IO.Path.GetFileName(RepoFullPath);
        var fork = await RepoService.ForkRepositoryAsync(dirName, UserService.Username, RootPath);
        if (fork != null)
        {
            var forkedDisplayName = fork.ForkedRepo.EndsWith(".git") ? fork.ForkedRepo[..^4] : fork.ForkedRepo;
            Nav.NavigateTo($"/repo/{forkedDisplayName}");
        }
    }

    private void CreateBranch()
    {
        using var repo = new Repository(RepoFullPath);
        var target = repo.Lookup<Commit>(latestCommit?.Sha);
        if (target != null) repo.CreateBranch(newBranchName, target);
        currentBranch = newBranchName; showNewBranchModal = false; LoadRepoData();
    }

    private void DeleteBranch(string branchName)
    {
        if (!UserService.IsLoggedIn || branchName == currentBranch) return;
        try
        {
            using var repo = new Repository(RepoFullPath);
            var branch = repo.Branches[branchName];
            if (branch != null)
            {
                repo.Branches.Remove(branch);
            }
            LoadRepoData();
        }
        catch { }
    }

    private void CreateTag()
    {
        using var repo = new Repository(RepoFullPath);
        if (latestCommit != null) repo.ApplyTag(newTagName, latestCommit.Sha);
        showNewTagModal = false; LoadRepoData();
    }

    private void CommitChanges()
    {
        if (!UserService.IsLoggedIn) return;
        var targetPath = activeTab == "edit" ? Path : (string.IsNullOrEmpty(Path) ? newFileName : $"{Path}/{newFileName}");
        if (string.IsNullOrEmpty(targetPath)) return;
        using var repo = new Repository(RepoFullPath);
        var blob = repo.ObjectDatabase.CreateBlob(new MemoryStream(Encoding.UTF8.GetBytes(editingContent)));
        var tip = repo.Branches[currentBranch]?.Tip ?? repo.Branches["main"]?.Tip ?? repo.Branches["master"]?.Tip ?? repo.Head.Tip;
        var treeDef = tip != null ? TreeDefinition.From(tip.Tree) : new TreeDefinition();
        treeDef.Add(targetPath, blob, Mode.NonExecutableFile);
        var tree = repo.ObjectDatabase.CreateTree(treeDef);
        var author = new Signature(UserService.Username, UserService.Email, DateTimeOffset.Now);
        var parents = tip != null ? new[] { tip } : Array.Empty<Commit>();
        var commit = repo.ObjectDatabase.CreateCommit(author, author, commitMessage, tree, parents, true);
        var targetBranchName = string.IsNullOrEmpty(currentBranch) ? "main" : currentBranch;
        var branchRef = repo.Refs[$"refs/heads/{targetBranchName}"];
        if (branchRef == null) { repo.Branches.Add(targetBranchName, commit); repo.Refs.UpdateTarget("HEAD", $"refs/heads/{targetBranchName}"); }
        else repo.Refs.UpdateTarget(branchRef.CanonicalName, commit.Id.Sha);
        activeTab = "code"; LoadRepoData();
    }

    private void DeleteFileCommit()
    {
        if (!UserService.IsLoggedIn) return;
        using var repo = new Repository(RepoFullPath);
        var tip = repo.Branches[currentBranch]?.Tip;
        if (tip == null) return;
        var treeDef = TreeDefinition.From(tip.Tree);
        treeDef.Remove(Path);
        var tree = repo.ObjectDatabase.CreateTree(treeDef);
        var author = new Signature(UserService.Username, UserService.Email, DateTimeOffset.Now);
        var commit = repo.ObjectDatabase.CreateCommit(author, author, $"Delete {Path}", tree, new[] { tip }, true);
        repo.Refs.UpdateTarget(repo.Branches[currentBranch].Reference.CanonicalName, commit.Id.Sha);
        showDeleteModal = false; Path = GetParentPath(); LoadRepoData();
    }

    private void DeleteRepository()
    {
        if (!UserService.IsLoggedIn) return;
        try
        {
            var repoPath = RepoFullPath;

            if (Repository.IsValid(repoPath))
            {
                using (var repo = new Repository(repoPath))
                {
                }
            }

            DeleteDirectory(repoPath);
            Nav.NavigateTo("/");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting repository: {ex.Message}");
        }
    }

    private void DeleteDirectory(string path)
    {
        if (!Directory.Exists(path)) return;

        foreach (var file in Directory.GetFiles(path, "*", SearchOption.AllDirectories))
        {
            try
            {
                File.SetAttributes(file, FileAttributes.Normal);
                File.Delete(file);
            }
            catch
            {
            }
        }

        try
        {
            Directory.Delete(path, true);
        }
        catch
        {
            System.Threading.Thread.Sleep(100);
            try
            {
                Directory.Delete(path, true);
            }
            catch
            {
            }
        }
    }

    private List<UnifiedDiffRow> GetUnifiedDiffRows(List<string> lines)
    {
        var rows = new List<UnifiedDiffRow>();
        int oldLine = 0, newLine = 0;

        foreach (var line in lines)
        {
            if (line.StartsWith("diff") || line.StartsWith("index") || line.StartsWith("---") || line.StartsWith("+++"))
                continue;

            if (line.StartsWith("@@"))
            {
                var match = System.Text.RegularExpressions.Regex.Match(line, @"@@ -(\d+)(?:,\d+)? \+(\d+)(?:,\d+)? @@");
                if (match.Success)
                {
                    oldLine = int.Parse(match.Groups[1].Value);
                    newLine = int.Parse(match.Groups[2].Value);
                }
                rows.Add(new UnifiedDiffRow { OldNum = "...", NewNum = "...", Sign = ' ', Content = line, CssClass = "diff-hunk" });
                continue;
            }

            if (line.StartsWith("+"))
            {
                rows.Add(new UnifiedDiffRow { OldNum = "", NewNum = newLine.ToString(), Sign = '+', Content = line.Length > 1 ? line.Substring(1) : "", CssClass = "diff-added" });
                newLine++;
            }
            else if (line.StartsWith("-"))
            {
                rows.Add(new UnifiedDiffRow { OldNum = oldLine.ToString(), NewNum = "", Sign = '-', Content = line.Length > 1 ? line.Substring(1) : "", CssClass = "diff-removed" });
                oldLine++;
            }
            else
            {
                rows.Add(new UnifiedDiffRow { OldNum = oldLine.ToString(), NewNum = newLine.ToString(), Sign = ' ', Content = line, CssClass = "diff-context" });
                oldLine++;
                newLine++;
            }
        }
        return rows;
    }

    private List<DiffPair> GetSplitDiff(List<string> lines)
    {
        return GetSplitDiffWithLineNumbers(lines);
    }

    private List<DiffPair> GetSplitDiffWithLineNumbers(List<string> lines)
    {
        var pairs = new List<DiffPair>();
        var removals = new List<(string Line, int Num)>();
        var additions = new List<(string Line, int Num)>();
        int oldLine = 0, newLine = 0;

        void Flush()
        {
            int max = Math.Max(removals.Count, additions.Count);
            for (int i = 0; i < max; i++)
            {
                pairs.Add(new DiffPair
                {
                    Left = i < removals.Count ? removals[i].Line : null,
                    LeftLineNum = i < removals.Count ? removals[i].Num : 0,
                    Right = i < additions.Count ? additions[i].Line : null,
                    RightLineNum = i < additions.Count ? additions[i].Num : 0
                });
            }
            removals.Clear(); additions.Clear();
        }

        foreach (var line in lines)
        {
            if (line.StartsWith("@@"))
            {
                Flush();
                var match = System.Text.RegularExpressions.Regex.Match(line, @"@@ -(\d+)(?:,\d+)? \+(\d+)(?:,\d+)? @@");
                if (match.Success)
                {
                    oldLine = int.Parse(match.Groups[1].Value);
                    newLine = int.Parse(match.Groups[2].Value);
                }
                continue;
            }
            if (line.StartsWith("diff") || line.StartsWith("index") || line.StartsWith("---") || line.StartsWith("+++")) continue;
            if (line.StartsWith("-")) { removals.Add((line, oldLine)); oldLine++; }
            else if (line.StartsWith("+")) { additions.Add((line, newLine)); newLine++; }
            else
            {
                Flush();
                pairs.Add(new DiffPair { Left = line, LeftLineNum = oldLine, Right = line, RightLineNum = newLine });
                oldLine++; newLine++;
            }
        }
        Flush(); return pairs;
    }

    private List<Crumb> GetBreadcrumbs()
    {
        var result = new List<Crumb>();
        if (string.IsNullOrEmpty(Path)) return result;
        var parts = Path.Split('/', StringSplitOptions.RemoveEmptyEntries);
        string current = "";
        for (int i = 0; i < parts.Length; i++)
        {
            current = string.IsNullOrEmpty(current) ? parts[i] : $"{current}/{parts[i]}";
            result.Add(new Crumb { Name = parts[i], Path = current, IsLast = (i == parts.Length - 1) });
        }
        return result;
    }

    private string GetParentPath() => !string.IsNullOrEmpty(Path) && Path.Contains('/') ? Path.Substring(0, Path.LastIndexOf('/')) : "";

    private string GetRelativeTime(DateTime? date)
    {
        if (!date.HasValue) return "just now";
        var span = DateTime.Now - date.Value;
        if (span.TotalDays > 365) return $"{(int)(span.TotalDays / 365)} year{((int)(span.TotalDays / 365) != 1 ? "s" : "")} ago";
        if (span.TotalDays > 30) return date.Value.ToString("MMM dd, yyyy");
        if (span.TotalDays > 1) return $"{(int)span.TotalDays} days ago";
        if (span.TotalDays > 0.9) return "yesterday";
        if (span.TotalHours > 1) return $"{(int)span.TotalHours} hours ago";
        if (span.TotalMinutes > 1) return $"{(int)span.TotalMinutes} minutes ago";
        return "just now";
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1) { order++; len /= 1024; }
        return $"{len:0.#} {sizes[order]}";
    }

    private void HandleDragEnter()
    {
        isDragging = true;
    }

    private void HandleDragLeave()
    {
        isDragging = false;
    }

    private void HandleDragOver()
    {
    }

    private async Task HandleDrop(DragEventArgs e)
    {
        isDragging = false;
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        uploadError = "";
        try
        {
            foreach (var file in e.GetMultipleFiles(100))
            {
                if (file.Size > maxFileSize)
                {
                    uploadError = $"File {file.Name} exceeds maximum size of 50MB";
                    continue;
                }
                uploadFiles.Add(file);
            }
        }
        catch (Exception ex)
        {
            uploadError = $"Error selecting files: {ex.Message}";
        }
    }

    private void NavigateToCreateFile()
    {
        showCloneDropdown = false;
        EnterAddFileMode();
    }

    private void OpenUploadModal()
    {
        showCloneDropdown = false;
        showUploadModal = true;
    }

    private void RemoveUploadFile(IBrowserFile file)
    {
        uploadFiles.Remove(file);
    }

    private async Task CommitUploadedFiles()
    {
        if (!UserService.IsLoggedIn) return;
        if (!uploadFiles.Any()) return;

        uploadError = "";
        try
        {
            var fullPath = RepoFullPath;
            using var repo = new Repository(fullPath);

            var author = new Signature(UserService.Username, UserService.Email, DateTimeOffset.Now);
            var tip = repo.Branches[currentBranch]?.Tip ?? repo.Branches["main"]?.Tip ?? repo.Branches["master"]?.Tip ?? repo.Head?.Tip;
            var treeDef = tip != null ? TreeDefinition.From(tip.Tree) : new TreeDefinition();

            foreach (var file in uploadFiles)
            {
                using var stream = file.OpenReadStream(maxFileSize);
                using var memoryStream = new MemoryStream();
                await stream.CopyToAsync(memoryStream);
                memoryStream.Position = 0;

                var blob = repo.ObjectDatabase.CreateBlob(memoryStream);
                var relativePath = string.IsNullOrEmpty(Path) ? file.Name : $"{Path}/{file.Name}";
                treeDef.Add(relativePath, blob, Mode.NonExecutableFile);
            }

            var tree = repo.ObjectDatabase.CreateTree(treeDef);
            var message = string.IsNullOrEmpty(uploadCommitMessage) ? "Add files via upload" : uploadCommitMessage;
            var parents = tip != null ? new[] { tip } : Array.Empty<Commit>();
            var commit = repo.ObjectDatabase.CreateCommit(author, author, message, tree, parents, true);

            var targetBranchName = string.IsNullOrEmpty(currentBranch) ? "main" : currentBranch;
            var branchRef = repo.Refs[$"refs/heads/{targetBranchName}"];
            if (branchRef == null) { repo.Branches.Add(targetBranchName, commit); repo.Refs.UpdateTarget("HEAD", $"refs/heads/{targetBranchName}"); }
            else repo.Refs.UpdateTarget(branchRef.CanonicalName, commit.Id.Sha);

            uploadFiles.Clear();
            uploadCommitMessage = "Add files via upload";
            showUploadModal = false;
            LoadRepoData();
        }
        catch (Exception ex)
        {
            uploadError = $"Error uploading files: {ex.Message}";
        }
    }

    private async Task CopyCloneUrl()
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", CloneUrl);
        }
        catch
        {
        }
    }

    private void OpenFolderUpload()
    {
        showCloneDropdown = false;
        folderBrowserFiles.Clear();
        folderFilePaths.Clear();
        folderUploadError = "";
        folderUploadInfo = "";
        folderUploadCommitMessage = "Add folder via upload";
        folderUploading = false;
        folderUploadProgress = 0;
        showFolderUploadModal = true;
    }

    private async Task HandleFolderSelected(InputFileChangeEventArgs e)
    {
        folderUploadError = "";
        folderUploadInfo = "";
        try
        {
            var allFiles = e.GetMultipleFiles(10000).ToList();

            // Get relative paths from the DOM input element via JS
            var paths = await JS.InvokeAsync<string[]>("folderUpload.getRelativePaths", "folderInput");

            // First pass: read .gitignore if present in the uploaded folder
            var gitignorePatterns = new List<string>();
            for (int i = 0; i < allFiles.Count; i++)
            {
                var fullRelPath = (i < paths.Length) ? paths[i] : allFiles[i].Name;
                var parts = fullRelPath.Replace('\\', '/').Split('/', 2);
                var commitPath = parts.Length > 1 ? parts[1] : parts[0];

                if (commitPath == ".gitignore" && allFiles[i].Size < 100_000)
                {
                    try
                    {
                        using var stream = allFiles[i].OpenReadStream(maxFileSize);
                        using var reader = new StreamReader(stream);
                        var content = await reader.ReadToEndAsync();
                        gitignorePatterns = content.Split('\n', StringSplitOptions.RemoveEmptyEntries).ToList();
                    }
                    catch { }
                    break;
                }
            }

            // Second pass: filter files and build the list
            folderBrowserFiles.Clear();
            folderFilePaths.Clear();
            int totalCount = allFiles.Count;
            int filteredIndex = 0;

            for (int i = 0; i < allFiles.Count; i++)
            {
                var fullRelPath = (i < paths.Length) ? paths[i] : allFiles[i].Name;
                var parts = fullRelPath.Replace('\\', '/').Split('/', 2);
                var commitPath = parts.Length > 1 ? parts[1] : parts[0];

                if (ShouldIgnoreFile(commitPath, gitignorePatterns))
                    continue;

                folderBrowserFiles.Add(allFiles[i]);
                folderFilePaths[filteredIndex] = commitPath;
                filteredIndex++;
            }

            int skipped = totalCount - folderBrowserFiles.Count;
            if (skipped > 0)
            {
                folderUploadInfo = $"Filtered out {skipped} files (build artifacts, .git, node_modules, etc.)";
            }
        }
        catch (Exception ex)
        {
            // Fallback: if JS path retrieval fails, use just filenames
            folderFilePaths.Clear();
            for (int i = 0; i < folderBrowserFiles.Count; i++)
            {
                folderFilePaths[i] = folderBrowserFiles[i].Name;
            }
            folderUploadError = $"Note: Could not read folder structure. Files will be uploaded flat. ({ex.Message})";
        }
    }

    private async Task CommitFolderUpload()
    {
        if (!UserService.IsLoggedIn) return;
        if (!folderBrowserFiles.Any()) return;

        folderUploadError = "";
        folderUploading = true;
        folderUploadProgress = 0;
        StateHasChanged();

        try
        {
            var fullPath = RepoFullPath;
            using var repo = new Repository(fullPath);

            var author = new Signature(UserService.Username, UserService.Email, DateTimeOffset.Now);
            var tip = repo.Branches[currentBranch]?.Tip ?? repo.Branches["main"]?.Tip ?? repo.Branches["master"]?.Tip ?? repo.Head?.Tip;
            var treeDef = tip != null ? TreeDefinition.From(tip.Tree) : new TreeDefinition();

            int skippedLarge = 0;
            for (int i = 0; i < folderBrowserFiles.Count; i++)
            {
                var file = folderBrowserFiles[i];
                if (file.Size > maxFileSize) { skippedLarge++; continue; }

                using var stream = file.OpenReadStream(maxFileSize);
                using var memoryStream = new MemoryStream();
                await stream.CopyToAsync(memoryStream);
                memoryStream.Position = 0;

                var blob = repo.ObjectDatabase.CreateBlob(memoryStream);
                var commitPath = folderFilePaths.ContainsKey(i) ? folderFilePaths[i] : file.Name;
                var relativePath = string.IsNullOrEmpty(Path) ? commitPath : $"{Path}/{commitPath}";
                treeDef.Add(relativePath, blob, Mode.NonExecutableFile);

                folderUploadProgress = (int)((i + 1) * 100.0 / folderBrowserFiles.Count);
                if (i % 25 == 0) // Update UI every 25 files
                {
                    await Task.Yield();
                    StateHasChanged();
                }
            }

            var tree = repo.ObjectDatabase.CreateTree(treeDef);
            var message = string.IsNullOrEmpty(folderUploadCommitMessage) ? "Add folder via upload" : folderUploadCommitMessage;
            var parents = tip != null ? new[] { tip } : Array.Empty<Commit>();
            var commit = repo.ObjectDatabase.CreateCommit(author, author, message, tree, parents, true);

            var targetBranchName = string.IsNullOrEmpty(currentBranch) ? "main" : currentBranch;
            var branchRef = repo.Refs[$"refs/heads/{targetBranchName}"];
            if (branchRef == null) { repo.Branches.Add(targetBranchName, commit); repo.Refs.UpdateTarget("HEAD", $"refs/heads/{targetBranchName}"); }
            else repo.Refs.UpdateTarget(branchRef.CanonicalName, commit.Id.Sha);

            if (skippedLarge > 0)
            {
                folderUploadError = $"Warning: {skippedLarge} file(s) skipped (exceeded 50MB size limit)";
            }

            folderBrowserFiles.Clear();
            folderFilePaths.Clear();
            showFolderUploadModal = false;
            folderUploading = false;
            LoadRepoData();
        }
        catch (Exception ex)
        {
            folderUploadError = $"Error uploading folder: {ex.Message}";
            folderUploading = false;
        }
    }

    private static bool BranchMatchesPattern(string branchName, string pattern)
    {
        if (pattern == branchName) return true;
        if (pattern.Contains('*'))
        {
            var regexPattern = "^" + Regex.Escape(pattern).Replace("\\*", ".*") + "$";
            return Regex.IsMatch(branchName, regexPattern);
        }
        return false;
    }

    private async Task LoadBranchProtectionRules()
    {
        branchProtectionRules = await BranchProtectionService.GetRulesAsync(RepoName);
    }

    private async Task SaveBranchProtectionRule()
    {
        if (!UserService.IsLoggedIn) return;
        if (string.IsNullOrWhiteSpace(newProtectionRule.BranchPattern)) return;
        await BranchProtectionService.AddRuleAsync(RepoName, newProtectionRule);
        newProtectionRule = new BranchProtectionRule { BranchPattern = "" };
        showAddProtectionRule = false;
        await LoadBranchProtectionRules();
    }

    private async Task DeleteBranchProtectionRule(int ruleId)
    {
        if (!UserService.IsLoggedIn) return;
        await BranchProtectionService.DeleteRuleAsync(RepoName, ruleId);
        await LoadBranchProtectionRules();
    }

    private string GetPrismLanguageClass(string? filePath)
    {
        if (string.IsNullOrEmpty(filePath)) return "language-none";
        var fileName = System.IO.Path.GetFileName(filePath).ToLowerInvariant();
        if (fileName == "dockerfile") return "language-docker";
        if (fileName == "makefile") return "language-makefile";
        if (fileName == ".gitignore" || fileName == ".gitattributes") return "language-git";
        var ext = System.IO.Path.GetExtension(filePath).ToLowerInvariant();
        return ext switch
        {
            ".cs" => "language-csharp",
            ".js" => "language-javascript",
            ".ts" => "language-typescript",
            ".tsx" => "language-tsx",
            ".jsx" => "language-jsx",
            ".py" => "language-python",
            ".rb" => "language-ruby",
            ".java" => "language-java",
            ".go" => "language-go",
            ".rs" => "language-rust",
            ".c" => "language-c",
            ".cpp" or ".cc" or ".cxx" => "language-cpp",
            ".h" or ".hpp" => "language-cpp",
            ".html" or ".htm" => "language-html",
            ".css" => "language-css",
            ".scss" => "language-scss",
            ".less" => "language-less",
            ".json" => "language-json",
            ".xml" => "language-xml",
            ".yaml" or ".yml" => "language-yaml",
            ".toml" => "language-toml",
            ".sql" => "language-sql",
            ".sh" or ".bash" => "language-bash",
            ".ps1" => "language-powershell",
            ".bat" or ".cmd" => "language-batch",
            ".dockerfile" => "language-docker",
            ".razor" => "language-cshtml",
            ".cshtml" => "language-cshtml",
            ".csproj" or ".sln" or ".props" or ".targets" => "language-xml",
            ".md" => "language-markdown",
            ".php" => "language-php",
            ".swift" => "language-swift",
            ".kt" or ".kts" => "language-kotlin",
            ".dart" => "language-dart",
            ".lua" => "language-lua",
            ".r" => "language-r",
            ".pl" or ".pm" => "language-perl",
            ".ex" or ".exs" => "language-elixir",
            ".erl" => "language-erlang",
            ".hs" => "language-haskell",
            ".fs" or ".fsx" => "language-fsharp",
            ".scala" => "language-scala",
            ".clj" => "language-clojure",
            ".vim" => "language-vim",
            ".ini" or ".cfg" or ".conf" => "language-ini",
            ".makefile" => "language-makefile",
            ".graphql" or ".gql" => "language-graphql",
            ".proto" => "language-protobuf",
            ".tf" => "language-hcl",
            _ => "language-none"
        };
    }

    public class GitCommit { public string Sha { get; set; } = ""; public string ShortSha { get; set; } = ""; public string AuthorName { get; set; } = ""; public string Message { get; set; } = ""; public DateTime Date { get; set; } }
    public class TreeItem { public string Name { get; set; } = ""; public bool IsDirectory { get; set; } public string LastCommitMessage { get; set; } = ""; public DateTime? LastCommitDate { get; set; } }
    public class Crumb { public string Name { get; set; } = ""; public string Path { get; set; } = ""; public bool IsLast { get; set; } }
    public class BranchSummary { public string Name { get; set; } = ""; public bool IsCurrent { get; set; } }
    public class TagSummary { public string Name { get; set; } = ""; public string TargetSha { get; set; } = ""; }
    public class FilePatch { public string Path { get; set; } = ""; public int LinesAdded { get; set; } public int LinesDeleted { get; set; } public List<string> DiffLines { get; set; } = new(); }
    public class DiffPair { public string? Left { get; set; } public string? Right { get; set; } public int LeftLineNum { get; set; } public int RightLineNum { get; set; } }
    public class UnifiedDiffRow { public string OldNum { get; set; } = ""; public string NewNum { get; set; } = ""; public char Sign { get; set; } public string Content { get; set; } = ""; public string CssClass { get; set; } = ""; }
    public class LanguageStat { public string Name { get; set; } = ""; public double Percentage { get; set; } public string Color { get; set; } = ""; }
}