@page "/repo/{RepoName}/compare"
@page "/repo/{RepoName}/compare/{Base}...{Head}"
@using LibGit2Sharp
@using System.IO
@using System.Text.RegularExpressions
@using MyPersonalGit.Data
@using MyPersonalGit.Services
@inject IConfiguration Config
@inject NavigationManager Nav
@inject IAdminService AdminService
@inject CurrentUserService UserService
@rendermode InteractiveServer

<PageTitle>Compare · @RepoName · Personal Git</PageTitle>

<div class="container-xl px-3 py-3">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/repo/@RepoName" class="text-decoration-none">@RepoName</a></li>
            <li class="breadcrumb-item active">Compare</li>
        </ol>
    </nav>

    <h2 class="h4 fw-bold mb-3">Comparing changes</h2>
    <p class="text-muted small mb-3">Choose two branches to see what's changed or start a new pull request.</p>

    <div class="d-flex align-items-center gap-2 mb-4 flex-wrap">
        <div>
            <label class="form-label small fw-semibold mb-1">base</label>
            <select class="form-select form-select-sm" style="min-width: 180px;" @bind="selectedBase">
                @foreach (var b in branches)
                {
                    <option value="@b">@b</option>
                }
            </select>
        </div>
        <div class="align-self-end pb-1">
            <i class="bi bi-arrow-left-right text-muted"></i>
        </div>
        <div>
            <label class="form-label small fw-semibold mb-1">compare</label>
            <select class="form-select form-select-sm" style="min-width: 180px;" @bind="selectedHead">
                @foreach (var b in branches)
                {
                    <option value="@b">@b</option>
                }
            </select>
        </div>
        <div class="align-self-end">
            <button class="btn btn-sm btn-gh-primary" @onclick="RunCompare">
                <i class="bi bi-arrow-left-right me-1"></i> Compare
            </button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(error))
    {
        <div class="alert alert-warning">@error</div>
    }

    @if (compared)
    {
        @if (selectedBase == selectedHead)
        {
            <div class="border rounded-3 p-4 text-center text-muted">
                <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
                <p class="mt-2 mb-0">These branches are identical. There's nothing to compare.</p>
            </div>
        }
        else
        {
            <!-- Summary -->
            <div class="border rounded-3 p-3 mb-3 bg-light-subtle">
                <div class="d-flex align-items-center gap-3 flex-wrap">
                    <span class="badge bg-primary bg-opacity-10 text-primary">
                        <i class="bi bi-git me-1"></i> @aheadCount commit@(aheadCount != 1 ? "s" : "") ahead
                    </span>
                    <span class="badge bg-secondary bg-opacity-10 text-secondary">
                        <i class="bi bi-file-earmark-diff me-1"></i> @filePatches.Count file@(filePatches.Count != 1 ? "s" : "") changed
                    </span>
                    <span class="badge bg-success bg-opacity-10 text-success">
                        +@totalAdded
                    </span>
                    <span class="badge bg-danger bg-opacity-10 text-danger">
                        -@totalDeleted
                    </span>

                    @if (UserService.IsLoggedIn)
                    {
                        <a href="/repo/@RepoName/pulls" class="btn btn-sm btn-gh-primary ms-auto">
                            <i class="bi bi-git me-1"></i> Create pull request
                        </a>
                    }
                </div>
            </div>

            <!-- Commits -->
            @if (commits.Any())
            {
                <div class="mb-3">
                    <h5 class="fw-bold small text-uppercase text-muted mb-2">
                        <i class="bi bi-clock-history me-1"></i> Commits
                    </h5>
                    <div class="list-group list-group-flush border rounded-3 overflow-hidden">
                        @foreach (var c in commits)
                        {
                            <div class="list-group-item d-flex justify-content-between align-items-center py-2 px-3">
                                <div>
                                    <span class="fw-semibold small">@c.MessageShort</span>
                                    <span class="text-muted small ms-2">@c.Author.Name</span>
                                </div>
                                <code class="small text-muted">@c.Id.ToString(7)</code>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Diff Toggle -->
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="fw-bold small text-uppercase text-muted mb-0">
                    <i class="bi bi-file-earmark-diff me-1"></i> Files changed
                </h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn @(diffMode == "unified" ? "btn-secondary" : "btn-outline-secondary")" @onclick='() => diffMode = "unified"'>Unified</button>
                    <button class="btn @(diffMode == "split" ? "btn-secondary" : "btn-outline-secondary")" @onclick='() => diffMode = "split"'>Split</button>
                </div>
            </div>

            <!-- File Diffs -->
            @foreach (var patch in filePatches)
            {
                <div class="border rounded-3 mb-3 overflow-hidden">
                    <div class="d-flex justify-content-between align-items-center px-3 py-2 bg-light-subtle border-bottom">
                        <span class="font-monospace small fw-semibold">@patch.Path</span>
                        <div>
                            <span class="badge bg-success bg-opacity-10 text-success me-1">+@patch.LinesAdded</span>
                            <span class="badge bg-danger bg-opacity-10 text-danger">-@patch.LinesDeleted</span>
                        </div>
                    </div>

                    <div class="overflow-auto" style="max-height: 600px;">
                        @if (diffMode == "unified")
                        {
                            <table class="table table-sm table-borderless mb-0 font-monospace" style="font-size: 12px;">
                                <tbody>
                                    @foreach (var row in GetUnifiedDiffRows(patch.DiffLines))
                                    {
                                        <tr class="@row.CssClass diff-line">
                                            <td class="text-muted px-2 text-end diff-linenum" style="width: 50px; user-select: none;">@row.OldNum</td>
                                            <td class="text-muted px-2 text-end diff-linenum" style="width: 50px; user-select: none;">@row.NewNum</td>
                                            <td class="px-1 diff-sign" style="width: 20px; user-select: none;">@(row.Sign == ' ' ? "" : row.Sign.ToString())</td>
                                            <td class="px-2 diff-text" style="white-space: pre-wrap; word-break: break-all;">@row.Content</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <table class="table table-sm table-borderless mb-0 font-monospace" style="font-size: 12px;">
                                <tbody>
                                    @foreach (var pair in GetSplitDiffWithLineNumbers(patch.DiffLines))
                                    {
                                        <tr class="diff-line">
                                            <td class="text-muted text-end px-1 diff-linenum @(pair.Left != null && pair.Left.StartsWith("-") ? "diff-removed" : "diff-context")" style="width: 40px; user-select: none;">@(pair.LeftLineNum > 0 ? pair.LeftLineNum.ToString() : "")</td>
                                            <td class="px-2 @(pair.Left == null ? "diff-empty" : pair.Left.StartsWith("-") ? "diff-removed" : "diff-context")" style="width: 50%; white-space: pre-wrap; word-break: break-all;">@(pair.Left != null && pair.Left.Length > 1 ? pair.Left.Substring(1) : pair.Left ?? "")</td>
                                            <td class="text-muted text-end px-1 diff-linenum @(pair.Right != null && pair.Right.StartsWith("+") ? "diff-added" : "diff-context")" style="width: 40px; user-select: none;">@(pair.RightLineNum > 0 ? pair.RightLineNum.ToString() : "")</td>
                                            <td class="px-2 @(pair.Right == null ? "diff-empty" : pair.Right.StartsWith("+") ? "diff-added" : "diff-context")" style="width: 50%; white-space: pre-wrap; word-break: break-all;">@(pair.Right != null && pair.Right.Length > 1 ? pair.Right.Substring(1) : pair.Right ?? "")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                    </div>
                </div>
            }
        }
    }
</div>

<style>
    .diff-added { background-color: var(--diff-added-bg, #e6ffec); color: var(--diff-added-fg, #1f883d); }
    .diff-removed { background-color: var(--diff-removed-bg, #fff1f0); color: var(--diff-removed-fg, #cf222e); }
    .diff-context { background-color: var(--diff-context-bg, white); color: var(--diff-context-fg, #1f2328); }
    .diff-empty { background-color: var(--diff-empty-bg, #f6f8fa); }
    .diff-line { border-bottom: 1px solid var(--gh-border, #f0f0f0); min-height: 20px; }
    .diff-sign { opacity: 0.6; }
    .diff-linenum { font-size: 11px; }
    .diff-hunk .diff-text { font-style: italic; font-size: 11px; }
</style>

@code {
    [Parameter] public string RepoName { get; set; } = "";
    [Parameter] public string? Base { get; set; }
    [Parameter] public string? Head { get; set; }

    private string RootPath = "/repos";
    private List<string> branches = new();
    private string selectedBase = "";
    private string selectedHead = "";
    private string error = "";
    private bool compared = false;
    private string diffMode = "unified";

    private int aheadCount;
    private int totalAdded;
    private int totalDeleted;
    private List<Commit> commits = new();
    private List<FilePatch> filePatches = new();

    protected override async Task OnInitializedAsync()
    {
        await ResolveRootPath();
        LoadBranches();

        if (!string.IsNullOrEmpty(Base) && !string.IsNullOrEmpty(Head))
        {
            selectedBase = Base;
            selectedHead = Head;
            RunCompare();
        }
    }

    private async Task ResolveRootPath()
    {
        var systemSettings = await AdminService.GetSystemSettingsAsync();
        if (!string.IsNullOrEmpty(systemSettings.ProjectRoot))
        {
            try
            {
                if (!Directory.Exists(systemSettings.ProjectRoot))
                    Directory.CreateDirectory(systemSettings.ProjectRoot);
                RootPath = systemSettings.ProjectRoot;
                return;
            }
            catch { }
        }

        var configuredPath = Config["Git:ProjectRoot"];
        if (!string.IsNullOrEmpty(configuredPath))
        {
            try
            {
                if (!Directory.Exists(configuredPath))
                    Directory.CreateDirectory(configuredPath);
                RootPath = configuredPath;
            }
            catch { }
        }
    }

    private string GetRepoFullPath()
    {
        var path = System.IO.Path.Combine(RootPath, RepoName);
        if (Repository.IsValid(path)) return path;
        if (Repository.IsValid(path + ".git")) return path + ".git";
        var nested = System.IO.Path.Combine(path, RepoName + ".git");
        if (Repository.IsValid(nested)) return nested;
        return path;
    }

    private void LoadBranches()
    {
        var repoPath = GetRepoFullPath();
        if (!Repository.IsValid(repoPath)) return;

        try
        {
            using var repo = new Repository(repoPath);
            branches = repo.Branches.Where(b => !b.IsRemote).Select(b => b.FriendlyName).ToList();

            if (branches.Any())
            {
                var headBranch = repo.Head?.FriendlyName;
                selectedBase = headBranch ?? branches.First();
                selectedHead = branches.Count > 1 ? branches.First(b => b != selectedBase) : selectedBase;
            }
        }
        catch (Exception ex)
        {
            error = $"Failed to load branches: {ex.Message}";
        }
    }

    private void RunCompare()
    {
        error = "";
        compared = false;
        commits.Clear();
        filePatches.Clear();
        aheadCount = 0;
        totalAdded = 0;
        totalDeleted = 0;

        if (string.IsNullOrEmpty(selectedBase) || string.IsNullOrEmpty(selectedHead))
        {
            error = "Please select both branches.";
            return;
        }

        if (selectedBase == selectedHead)
        {
            compared = true;
            return;
        }

        var repoPath = GetRepoFullPath();
        if (!Repository.IsValid(repoPath))
        {
            error = "Repository not found.";
            return;
        }

        try
        {
            using var repo = new Repository(repoPath);
            var baseBranch = repo.Branches[selectedBase];
            var headBranch = repo.Branches[selectedHead];

            if (baseBranch?.Tip == null || headBranch?.Tip == null)
            {
                error = "One or both branches have no commits.";
                return;
            }

            // Get commits ahead (in head but not in base)
            var filter = new CommitFilter
            {
                IncludeReachableFrom = headBranch.Tip,
                ExcludeReachableFrom = baseBranch.Tip,
                SortBy = CommitSortStrategies.Topological | CommitSortStrategies.Time
            };
            commits = repo.Commits.QueryBy(filter).ToList();
            aheadCount = commits.Count;

            // Get diff between trees
            var baseTree = baseBranch.Tip.Tree;
            var headTree = headBranch.Tip.Tree;
            var diff = repo.Diff.Compare<Patch>(baseTree, headTree);

            foreach (var change in diff)
            {
                var lines = change.Patch.Split('\n').ToList();
                var added = lines.Count(l => l.StartsWith("+") && !l.StartsWith("+++"));
                var deleted = lines.Count(l => l.StartsWith("-") && !l.StartsWith("---"));

                filePatches.Add(new FilePatch
                {
                    Path = change.Path,
                    LinesAdded = added,
                    LinesDeleted = deleted,
                    DiffLines = lines
                });

                totalAdded += added;
                totalDeleted += deleted;
            }

            compared = true;
        }
        catch (Exception ex)
        {
            error = $"Compare failed: {ex.Message}";
        }
    }

    private List<UnifiedDiffRow> GetUnifiedDiffRows(List<string> lines)
    {
        var rows = new List<UnifiedDiffRow>();
        int oldLine = 0, newLine = 0;

        foreach (var line in lines)
        {
            if (line.StartsWith("diff") || line.StartsWith("index") || line.StartsWith("---") || line.StartsWith("+++"))
                continue;

            if (line.StartsWith("@@"))
            {
                var match = Regex.Match(line, @"@@ -(\d+)(?:,\d+)? \+(\d+)(?:,\d+)? @@");
                if (match.Success)
                {
                    oldLine = int.Parse(match.Groups[1].Value);
                    newLine = int.Parse(match.Groups[2].Value);
                }
                rows.Add(new UnifiedDiffRow { OldNum = "...", NewNum = "...", Sign = ' ', Content = line, CssClass = "diff-hunk" });
                continue;
            }

            if (line.StartsWith("+"))
            {
                rows.Add(new UnifiedDiffRow { OldNum = "", NewNum = newLine.ToString(), Sign = '+', Content = line.Length > 1 ? line.Substring(1) : "", CssClass = "diff-added" });
                newLine++;
            }
            else if (line.StartsWith("-"))
            {
                rows.Add(new UnifiedDiffRow { OldNum = oldLine.ToString(), NewNum = "", Sign = '-', Content = line.Length > 1 ? line.Substring(1) : "", CssClass = "diff-removed" });
                oldLine++;
            }
            else
            {
                rows.Add(new UnifiedDiffRow { OldNum = oldLine.ToString(), NewNum = newLine.ToString(), Sign = ' ', Content = line, CssClass = "diff-context" });
                oldLine++;
                newLine++;
            }
        }
        return rows;
    }

    private List<DiffPair> GetSplitDiffWithLineNumbers(List<string> lines)
    {
        var pairs = new List<DiffPair>();
        var removals = new List<(string Line, int Num)>();
        var additions = new List<(string Line, int Num)>();
        int oldLine = 0, newLine = 0;

        void Flush()
        {
            int max = Math.Max(removals.Count, additions.Count);
            for (int i = 0; i < max; i++)
            {
                pairs.Add(new DiffPair
                {
                    Left = i < removals.Count ? removals[i].Line : null,
                    LeftLineNum = i < removals.Count ? removals[i].Num : 0,
                    Right = i < additions.Count ? additions[i].Line : null,
                    RightLineNum = i < additions.Count ? additions[i].Num : 0
                });
            }
            removals.Clear(); additions.Clear();
        }

        foreach (var line in lines)
        {
            if (line.StartsWith("@@"))
            {
                Flush();
                var match = Regex.Match(line, @"@@ -(\d+)(?:,\d+)? \+(\d+)(?:,\d+)? @@");
                if (match.Success)
                {
                    oldLine = int.Parse(match.Groups[1].Value);
                    newLine = int.Parse(match.Groups[2].Value);
                }
                continue;
            }
            if (line.StartsWith("diff") || line.StartsWith("index") || line.StartsWith("---") || line.StartsWith("+++")) continue;
            if (line.StartsWith("-")) { removals.Add((line, oldLine)); oldLine++; }
            else if (line.StartsWith("+")) { additions.Add((line, newLine)); newLine++; }
            else
            {
                Flush();
                pairs.Add(new DiffPair { Left = line, LeftLineNum = oldLine, Right = line, RightLineNum = newLine });
                oldLine++; newLine++;
            }
        }
        Flush(); return pairs;
    }

    public class FilePatch { public string Path { get; set; } = ""; public int LinesAdded { get; set; } public int LinesDeleted { get; set; } public List<string> DiffLines { get; set; } = new(); }
    public class DiffPair { public string? Left { get; set; } public string? Right { get; set; } public int LeftLineNum { get; set; } public int RightLineNum { get; set; } }
    public class UnifiedDiffRow { public string OldNum { get; set; } = ""; public string NewNum { get; set; } = ""; public char Sign { get; set; } public string Content { get; set; } = ""; public string CssClass { get; set; } = ""; }
}
