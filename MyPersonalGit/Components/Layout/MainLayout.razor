@inherits LayoutComponentBase
@using MyPersonalGit.Data
@using MyPersonalGit.Services
@inject IAdminService AdminService
@inject CurrentUserService UserService
@inject IJSRuntime JS
@inject NavigationManager Navigation

<div class="gh-app">
    <header class="gh-header">
        <div class="container-xl d-flex align-items-center py-2 px-3">
            <a class="gh-logo me-3 text-white text-decoration-none d-flex align-items-center" href="/">
                <svg height="32" aria-hidden="true" viewBox="0 0 16 16" version="1.1" width="32" fill="currentColor">
                    <path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"></path>
                </svg>
                <span class="ms-2 fw-semibold">Personal Git</span>
            </a>

            <div class="gh-search-container d-none d-md-flex flex-grow-1 mx-2" style="max-width: 300px;">
                <div class="input-group input-group-sm bg-dark-subtle rounded-2 border border-secondary border-opacity-50">
                    <input type="text" class="form-control bg-transparent border-0 text-white placeholder-secondary" placeholder="Search or jump to..." />
                    <span class="input-group-text bg-transparent border-0 text-secondary">/</span>
                </div>
            </div>

            <nav class="gh-nav-links d-none d-lg-flex ms-3 gap-3">
                <a href="/search?type=pulls" class="text-white text-opacity-75 text-decoration-none small fw-semibold">Pull requests</a>
                <a href="/search?type=issues" class="text-white text-opacity-75 text-decoration-none small fw-semibold">Issues</a>
                <a href="/search" class="text-white text-opacity-75 text-decoration-none small fw-semibold">Search</a>
                @if (UserService.IsAdmin)
                {
                    <a href="/admin" class="text-white text-opacity-75 text-decoration-none small fw-semibold">
                        <i class="bi bi-shield-lock me-1"></i>Admin
                    </a>
                }
            </nav>

            <div class="ms-auto d-flex align-items-center gap-3">
                @if (UserService.IsLoggedIn)
                {
                    <a href="/notifications" class="text-white text-opacity-75 text-decoration-none">
                        <i class="bi bi-bell"></i>
                    </a>
                    <div class="dropdown">
                        <button class="btn btn-link text-white text-opacity-75 text-decoration-none p-0 d-flex align-items-center" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-plus-lg"></i>
                            <i class="bi bi-caret-down-fill ms-1" style="font-size: 0.6rem;"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/repo/new">New repository</a></li>
                            <li><a class="dropdown-item" href="/issues/new">New issue</a></li>
                            <li><a class="dropdown-item" href="/projects/new">New project</a></li>
                        </ul>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-link text-white text-decoration-none p-0 d-flex align-items-center" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="gh-avatar rounded-circle bg-secondary border border-white border-opacity-25 d-flex align-items-center justify-content-center text-white" style="width: 24px; height: 24px;">
                                <i class="bi bi-person-fill" style="font-size: 0.8rem;"></i>
                            </div>
                            <i class="bi bi-caret-down-fill ms-1 text-white text-opacity-75" style="font-size: 0.6rem;"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><span class="dropdown-item-text fw-semibold">@UserService.Username</span></li>
                            <li><hr class="dropdown-divider" /></li>
                            <li><a class="dropdown-item" href="/profile/@UserService.Username">Your profile</a></li>
                            <li><a class="dropdown-item" href="/settings">Settings</a></li>
                            <li><hr class="dropdown-divider" /></li>
                            <li><button class="dropdown-item" @onclick="HandleLogout">Sign out</button></li>
                        </ul>
                    </div>
                }
                else
                {
                    <a href="/login" class="btn btn-sm btn-outline-light">Sign in</a>
                }
            </div>
        </div>
    </header>

    <main class="gh-main">
        <div class="container-xl py-4 px-3">
            @Body
        </div>
    </main>

    <footer class="gh-footer border-top py-5 mt-auto">
        <div class="container-xl px-3 d-flex flex-wrap justify-content-center gap-4 small">
            <span class="text-muted">Â© @DateTime.Now.Year PersonalGit, Inc.</span>
            <a href="#" class="text-decoration-none text-primary-emphasis">Terms</a>
            <a href="#" class="text-decoration-none text-primary-emphasis">Privacy</a>
            <a href="#" class="text-decoration-none text-primary-emphasis">Docs</a>
            <a href="#" class="text-decoration-none text-primary-emphasis">Contact</a>
        </div>
    </footer>
</div>

<style>
    :root {
        --gh-header: #24292f;
        --gh-border: #d0d7de;
        --gh-text: #1f2328;
        --gh-bg: #ffffff;
    }

    body {
        color: var(--gh-text);
        font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;
        background-color: var(--gh-bg);
        margin: 0;
    }

    .gh-app {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    .gh-header {
        background-color: var(--gh-header);
        color: white;
    }

    .gh-nav-links a:hover {
        color: white !important;
    }

    .placeholder-secondary::placeholder {
        color: rgba(255,255,255,0.5) !important;
    }

    .btn-gh-primary {
        background-color: #1f883d;
        color: white;
        border: 1px solid rgba(27,31,36,0.15);
        font-weight: 600;
        padding: 5px 16px;
        font-size: 14px;
        border-radius: 6px;
    }

        .btn-gh-primary:hover {
            background-color: #1a7f37;
            color: white;
        }

    .gh-main {
        flex: 1;
    }
</style>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var sessionId = await JS.InvokeAsync<string>("sessionHelper.get", "sessionId");
                if (!string.IsNullOrEmpty(sessionId))
                {
                    await UserService.InitializeFromSessionAsync(sessionId);
                    StateHasChanged();
                }
            }
            catch { }
        }
    }

    private async Task HandleLogout()
    {
        await UserService.LogoutAsync();
        await JS.InvokeVoidAsync("sessionHelper.remove", "sessionId");
        Navigation.NavigateTo("/login", forceLoad: true);
    }
}